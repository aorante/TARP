/* ========================================================================== */
/*   The Alan Randoms Project v1                                              */
/*   tarp.c                                                                   */
/*   by mvac7/303bcn 2020                                                     */
/*   eXperimental Sound miniCompo (XSmC)                                      */
/*   Description:                                                             */
/*     Random music maker                                                     */
/* ========================================================================== */


/* -----------------------------------------------------------------------------
Notas del autor:

Tareas para una futura version: 
- usar envolvente por soft para percusion. 
- Añadir editor de instrumentos.
- probar con SCC
- mejorar el sistema de envolventes por soft. Necesitaria usar interrupciones 
por linea para aumentar la resolucion de la forma de los volumenes. 

----------------------------------------------------------------------------- */


//__sfr __at 0xA8 g_slotPort;
#include "../include/msxSystemVars.h"
#include "../include/msxBIOS.h"
#include "../include/newTypes.h"
#include "../include/VDP_TMS9918.h"
#include "../include/VDP_sprites.h"
#include "../include/joystick.h"
#include "../include/keyboard.h"
#include "../include/memory.h"
#include "../include/unRLEWBtoVRAM.h"
#include "../include/unRLEWBtoRAM.h"


#define  HALT __asm halt __endasm
  


// AY-3-8910 MSX Internal PSG
#define AY0index 0xA0
#define AY0write 0xA1
#define AY0read  0xA2


// ------------------------- GUI Tiles
#define GUI_SWITCHER     223
#define GUI_SWITCHER_ON  221
#define GUI_SWITCHER_OFF 222

#define GUI_CASIO_VADDR   0x1929
#define GUI_ABMIX_VADDR   0x19C9
#define GUI_ENVLOOP_VADDR 0x1A49

#define GUI_DRUM_VADDR    0x18EA  //speaker
#define GUI_TONE_VADDR    0x198A  //speaker

#define GUI_SPEAKER_ON   217
#define GUI_SPEAKER_OFF  216

#define GUI_CURSOR       215 //186
#define GUI_SEQCURSOR    214 //185

#define GUI_SEQ_VADDR       0x1AAE
#define GUI_SEQ_DRUM_VADDR  0x1ACE
#define GUI_SEQ_TONE_VADDR  0x1AEE
#define GUI_SEQ_INSTR    209 // 180
#define GUI_SEQ_TONE     213 // 184

#define GUI_SCROLLBAR       127 //159
#define GUI_SCROLLBAR_EMPTY 126 //158

#define GUI_EMPTY         32
#define GUI_EMPTY_BLACK  255
// ------------------------- END GUI Tiles



typedef struct {

  boolean isTone;
  boolean isNoise;
  uint Tone;
  char Noise;
  char Shape;
  uint Period;
    
} DRUM_INST;



typedef struct {

  boolean isLoop;
  char ampValues[16];
  //char length;
    
} Envelope;



void logoScreen();
void WorkWin();

void wipe2theMiddle();

void setSprites();

void setTileset();
void showMainScr();

void initGUI();

void Help();
void showHelpScr();
void initHelpText();
void showHelpText(char line);
void showScrollbar(char line);

void showLogoScreen();

void setMSX2Palette();
void SetPalette(char number);

void showEnv(char value);
void showSpeaker(uint vaddr, boolean value);
void switcher(uint vaddr, boolean value);

void invertDrumChannel();
void invertToneChannel();
//void setChannelsState(boolean state);

void CopyPrevPatterns();
void RestorePrevPatterns();

void genDrumPattern();
void genTonePattern();

void ShowSequenceCursor();

void ShowPattern();
void ShowDrumPattern();
void ShowTonePattern();

void upNotePattern();
void downNotePattern();
int getFreq(char value);
void upOctave();
void downOctave();
void showOctave();

void SetDrumKit(boolean kit);

void checkMSX();

char Rnd(char value);

void PlayerInit();
void PlayerDecode();
void PlayAY();
void SetMixer(char NumChannel, boolean isTone, boolean isNoise);
void Silence();

void Play();
void Stop();

uint GetVAddressByPosition(char column, char line);
void VPRINT(char column, char line, char* text);
void VPrintNumber(char posx, char posy, uint aNumber, char aLength);
void num2Dec16(uint aNumber, char *address);




// definicion variables globales <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
const char app_name[] = "THE ALAN RANDOMS PROJECT"; 
const char app_author[] = "MVAC7/303BCN";
const char app_version[] = "0.9.15b";


const char enve_data[128]={
14,13,12,11,10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 0,  
 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,14,  
14,12,10, 8, 6, 4, 2, 1, 0, 1, 2, 4, 6, 8,10,12,  
 0, 1, 2, 4, 6, 8,10,12,14,12,10, 8, 6, 4, 2, 1,  
14,14,14,14,14,14,14,14, 4, 4, 4, 4, 4, 4, 4, 4, 
 7, 9,12,13,13,13,11, 8, 5, 2, 0, 0, 0, 1, 4, 6, 
14,13,13,12,11,10, 9, 8, 6, 5, 3, 2, 1, 0, 0, 0, 
14,13,12,11,10, 9, 9, 9, 9, 9, 9, 9, 8, 6, 4, 2
};

const char enve_loop[8]={false,false,true,true,false,false,false,false};



const char drumcolor[4]={4,12,8,7};

#define OPTIONS_SIZE  15

const uint vaddr_cursor[OPTIONS_SIZE+1]={
0x1841,0x1861,0x1881,
0x18E1,0x1901,0x1921,
0x1981,0x19A1,0x19C1,0x19E1,0x1A01,0x1A21,0x1A41,0x1A61,0x1A81,
0x1AC1};

const char yvalues[64]={
  72,65,59,53,47,41,35,30,26,21,18,15,12,10,8,8,
  8,8,9,11,13,16,20,24,28,33,38,44,50,56,62,68,
  75,81,87,93,99,105,110,115,119,123,127,130,132,134,135,135,
  135,135,133,131,128,125,122,117,113,108,102,96,90,84,78,72
};   //sin 8,136     



const char xvalues[64]={
     96,96,97,98,101,103,107,110,115,120,125,130,136,142,148,155,
     161,167,174,180,186,192,197,202,206,211,214,217,220,222,223,223,
     223,223,222,220,217,214,211,206,202,197,192,186,180,174,167,161,
     155,148,142,136,130,125,120,115,110,107,103,101,98,97,96,96
};   //cos 96,224     


//global variables -------------------------------------------------------------

char VDP_type;


// Player ----------------------------------------------------------------------
#define PLAYER_STOP 0
#define PLAYER_PLAY 1

char _playerHardware;  //(1B) indica por que chip ha de sonar (0=PSG interno;1=PSG MFR;2=[SCC?])

char _playerStatus;    // 0=off ; >0 = On

char _tempo;
char _octave;

boolean _ToneEnabled; //_ToneEnabled
boolean _DrumEnabled; //_DrumEnabled

boolean _AB_MIX;
char _AB_offset;

char _env_index;
char _env_speed;
char _env_step;

char _toneAmp;

char _tempoStep;
char _pattern_step;
char _last_step;
char _ENDstep;  //to control the size of the pattern
char _newENDstep;

DRUM_INST *_Drum;
DRUM_INST _DrumKit[3];

char AYREGS[14]; //PSG Registers Buffer R0-R13 
// -----------------------------------------------------------------------------


char drum_pattern[16];
char tone_pattern[16]; //={46,0,49,0,50,0,51,0,46,0,49,0,50,0,51,0};

char prev_drum_pattern[16];  // #9
char prev_tone_pattern[16];

Envelope envelope_list[8];


char SEED;

signed char _cursor_pos;

boolean _isCasio;

// -----------------------------------------------------------------------------
#define HELP_WIDTH    29
#define HELP_LINES    35
#define HELP_sizeBar  13   //(20/HELP_LINES)*20

char    HELP_TXTADDR[(HELP_LINES+1)*29];
// -----------------------------------------------------------------------------



void main(void) {
  
  checkMSX();
  
  COLOR(15,1,1);  
  SCREEN(2);  
  
  POKE(CLIKSW,0);
  
  initHelpText();
  
  logoScreen();
  

  wipe2theMiddle(); //screen transition
  //FillVRAM(BASE10, 768, 255); //clear screen
    
    
  WorkWin();
}



void wipe2theMiddle()
{
  signed char x;
  char y;
    
  HALT;
  ClearSprites();
    
  FillVRAM(BASE11+0x7F8, 8, 0x11); //clear screen
  FillVRAM(BASE11+0x0FF8, 8, 0x11); //clear screen
  FillVRAM(BASE11+0x17F8, 8, 0x11); //clear screen
  
  for (x=0;x<16;x++)
  {
    for (y=0;y<24;y++)
    {
        VPOKE(BASE10+(y*32)+x,255);
        VPOKE(BASE10+(y*32)+(31-x),255);    
    } 
    HALT;
  }
}


void logoScreen()
{
  int timec = 700;
  
  SetSpritesSize(1);
  //SetSpritesZoom(false);
   
  showLogoScreen();  
  
  //Show Sprites to add more colors to the drawing.
  PUTSPRITE(0,74,58,12,0);
  PUTSPRITE(1,73,74,12,1);    
  PUTSPRITE(2,96,57,12,2);     
  PUTSPRITE(3,95,73,12,3);
  PUTSPRITE(4,80,64,2,4);
  PUTSPRITE(5,102,62,2,4);
 
  
  if (VDP_type>0) SetPalette(0);  
  
  while(timec-->0)
  {
    HALT;
    if (!(GetKeyMatrix(7)&Bit2)) break; // ESC
    if (!(GetKeyMatrix(7)&Bit7)) break; // RETURN
    if (!(GetKeyMatrix(8)&Bit0)) break; // SPACE 
    if (STRIG(1)>0) break; //button 1, joy A
    if (STRIG(2)>0) break; //button 1, joy B    
  }

  return;
}




void WorkWin()
{
    
    // key press control
    boolean keyB0pressed=false;
    boolean keyB2pressed=false;
    boolean keyB6pressed=false;
    boolean keyB7pressed=false;
    boolean keyB8pressed=false;
    
    boolean joybool = false;
    boolean joytrigbool = false;
    //    
      
    
    //sprite for tone vars
    char stone_step=0; //de 31
    char stone_size;
    char stone_color;
    
    //sprite for drums vars 
    char sdrum_step=31;
    char sdrum_size=0;
    char sdrum_color=15;
    //char variacion=0;
    
    char drum_type;
    
    char vumeterStep;
    
    char i,o;
    char conta=0;
    
    char keyPressed;
    
    char joyval;
    char joytrig;
    
    //char pattern[16]={1,0,3,3,0,0,3,3,1,0,3,3,0,0,3,3}; 
    //char pattern[16]={1,0,3,0,2,0,2,0,1,0,3,0,2,0,3,0}; //rock1
    
    _cursor_pos=0;
    
    // initialize data structures of volume envelopes
    for(i=0;i<8;i++)
    {
      envelope_list[i].isLoop = enve_loop[i];
      for(o=0;o<16;o++)
      {
        envelope_list[i].ampValues[o] = enve_data[conta++];
      }    
    }
    // end
    
    
    
    //initialize sprite hardware
    SetSpritesSize(1);    //16x16
    SetSpritesZoom(true); //zoom
    
    setSprites();
    
    // erase sprites 2 & 3  ???
    //SetSpritePattern(2,31);
    //SetSpritePattern(3,31);
  
    setTileset();
  
    if (VDP_type>0) SetPalette(1); //V9938 palette
    
    showMainScr();
    
    
    _ToneEnabled=true;
    _DrumEnabled=true;
    

    _playerHardware=0; //select internal AY
    _playerStatus=PLAYER_STOP;  
    
    _isCasio = false;
    _AB_MIX = true;
    
    SetDrumKit(_isCasio);    
    
    PlayerInit();
    
    vumeterStep = _tempo;
        
    
    // genera los patrones de percusion y tono
    //genDrumPattern();
    //genTonePattern();
    //CopyPrevPatterns();
    for(i=0;i<16;i++)
    {
        drum_pattern[i]=0;
        tone_pattern[i]=0;
        prev_drum_pattern[i]=0;
        prev_tone_pattern[i]=0;
    }
   
    
    // activa los canales A y B del AY (registro 7)  
    SetMixer(0,true,false);
    SetMixer(1,true,false);
    
    //VPrintNumber(8,2, _tempo, 1);
    
    // muestra los valores de los controles
    initGUI();
    // end set visual controls values
       
    
    // posiciona el cursor de seleccion de campo 
    //VPOKE(vaddr_cursor[_cursor_pos],GUI_CURSOR);   
    
    
    while(1)
    {
      HALT;
      PlayAY(); //Dump values from RAM buffer to PSG (AY)
     

      // ############################################################### VISUALS
      if (_playerStatus==PLAYER_PLAY && _tempoStep==0) //control de tempo por ciclos de Vblank 
      {
        ShowSequenceCursor();               
        
        // control de la percusion
        if(_DrumEnabled==true)
        {
          drum_type = drum_pattern[_pattern_step];
          if(drum_type>0)
          {                       
            sdrum_size=7;
            sdrum_color=drumcolor[drum_type];     
          }
        }           
      }
      
                     
      //Tone
      stone_size = AYREGS[8];
      stone_size = stone_size>>1;   // /2
      //SetSpritePosition(0,xvalues[stone_step],yvalues[stone_step]);
      //SetSpritePattern(0,stone_size);
      if (stone_size>0) stone_color = 15;
      else stone_color = 14;
      //SetSpriteColor(0,stone_color);      
      PUTSPRITE(0,xvalues[stone_step],yvalues[stone_step],stone_color,stone_size);
      
      //Drum
      if (_DrumEnabled==false) sdrum_size=0;
            
      if (sdrum_size==0) sdrum_color=drumcolor[0];
      //SetSpritePosition(1,xvalues[sdrum_step],yvalues[sdrum_step]);
      //SetSpritePattern(1,sdrum_size);
      //SetSpriteColor(1,sdrum_color);
      PUTSPRITE(1,xvalues[sdrum_step],yvalues[sdrum_step],sdrum_color,sdrum_size);
      
      
      if (sdrum_size>0) sdrum_size--;
      
      if (vumeterStep>=_tempo-1)
      {
        vumeterStep=0;
              
        stone_step++;
        if (stone_step>63) stone_step=0;
        sdrum_step++;
        if (sdrum_step>63) sdrum_step=0;
      }else{
          vumeterStep++;
      }
      // ########################################################### END VISUALS
      
      
      if (_playerStatus==PLAYER_PLAY) PlayerDecode();
      
      
      joyval=STICK(0);
      if (joyval==0) joyval=STICK(1);
      if (joyval==0) joyval=STICK(2);
      if (joyval>0)
      {
        if (joybool==false)
        {
          joybool = true;
          VPOKE(vaddr_cursor[_cursor_pos],32);       
          
          if(joyval==1) // arriba
          { 
            _cursor_pos--;
            if(_cursor_pos<0) _cursor_pos=OPTIONS_SIZE; 
          }
          if(joyval==5) // abajo
          {
            _cursor_pos++;
            if(_cursor_pos>OPTIONS_SIZE) _cursor_pos=0;           
          }
          if(joyval==3) // right
          { 
            switch (_cursor_pos)   //{0x1841,0x1901,0x19A1,0x19C1,0x1A01,0x1A21,0x1A41,0x1A81,0x1AA1};
            {
              case 2: //tempo
                if (_tempo<8) _tempo++;                
                VPrintNumber(8,4, _tempo, 1);
                break;
              case 5: //Drum KIT Switcher
                _isCasio=true;
                SetDrumKit(_isCasio);
                switcher(GUI_CASIO_VADDR,true); 
                break;
              case 8: //A+B
                _AB_MIX=true;
                switcher(GUI_ABMIX_VADDR,true); 
                break;
              case 9: //B offset
                //if (_AB_offset<254) 
                _AB_offset++;                
                VPrintNumber(6,15, _AB_offset, 3); 
                break;
              case 10: //envelope wave
                if (_env_index<7) _env_index++;
                showEnv(_env_index);
                switcher(GUI_ENVLOOP_VADDR,envelope_list[_env_index].isLoop); 
                break;
              case 11: //envelope speed
                if (_env_speed<3) _env_speed++;
                VPrintNumber(8,17, _env_speed, 1); 
                break;
              case 12: //loop Switcher
                envelope_list[_env_index].isLoop=true;
                switcher(GUI_ENVLOOP_VADDR,true);
                break;
              case 13: // _octave +
                downOctave(); 
                break;
              case 14:
                downNotePattern(); 
                break;
            } 
          }
          if(joyval==7) // left
          { 
            switch (_cursor_pos) 
            {
              case 2:
                if (_tempo>1) _tempo--;                
                VPrintNumber(8,4, _tempo, 1); 
                break;
              case 5:
                _isCasio=false;
                SetDrumKit(_isCasio);
                switcher(GUI_CASIO_VADDR,false); 
                break;
              case 8:
                _AB_MIX=false;
                switcher(GUI_ABMIX_VADDR,false); 
                break;
              case 9:
                //if (_AB_offset>0) 
                _AB_offset--;                
                VPrintNumber(6,15, _AB_offset, 3); 
                break;
              case 10:
                if (_env_index>0) _env_index--;
                showEnv(_env_index);
                switcher(GUI_ENVLOOP_VADDR,envelope_list[_env_index].isLoop); 
                break;
              case 11:
                if (_env_speed>1) _env_speed--;
                VPrintNumber(8,17, _env_speed, 1); 
                break;
              case 12:
                envelope_list[_env_index].isLoop=false;
                switcher(GUI_ENVLOOP_VADDR,false); 
                break;
              case 13: //_octave -
                upOctave();
                break;
              case 14:
                upNotePattern(); 
                break;
            } 
          }
          VPOKE(vaddr_cursor[_cursor_pos],GUI_CURSOR);
        }
      }else{
        joybool = false;
      }
      
      
    joytrig = STRIG(0);       
    if (joytrig==0) joytrig=STRIG(1);
    if (joytrig==0) joytrig=STRIG(2);
    if (joytrig>0)
    {
      if (joytrigbool==false)
      {
        joytrigbool = true;
        
        switch (_cursor_pos) 
        {
            case 0:    //random All
                CopyPrevPatterns();
                genDrumPattern();
                genTonePattern(); 
                break;
            case 1:    //Play
                if(_playerStatus==PLAYER_STOP) Play();
                else Stop(); 
                break;
            case 3:    //Rhythm channel On/Off
                invertDrumChannel();
                break;
            case 4:    //random Rhithm
                CopyPrevPatterns();
                genDrumPattern(); 
                break;
            case 5:
                _isCasio=!_isCasio;
                SetDrumKit(_isCasio);
                switcher(GUI_CASIO_VADDR,_isCasio); 
                break;
            case 6:    //Melody channel On/Off
                invertToneChannel();
                break;
            case 7:    //random Melody
                CopyPrevPatterns();
                genTonePattern(); 
                break;
            case 8:
                _AB_MIX=!_AB_MIX;
                switcher(GUI_ABMIX_VADDR,_AB_MIX); 
                break;
            case 12:
                envelope_list[_env_index].isLoop=!envelope_list[_env_index].isLoop;
                switcher(GUI_ENVLOOP_VADDR,envelope_list[_env_index].isLoop); 
                break;
            case 15:
                Help();
                break;
            
        }    
      }       
    }else joytrigbool = false;
    
      
      
      

      keyPressed = GetKeyMatrix(0);
      if (keyPressed!=0xFF)
      {
        if(keyB0pressed==false)
        {
          //if (!(keyPressed&Bit0)) {keyB0pressed=true;}; // 0
          if (!(keyPressed&Bit1)) {_newENDstep=1;keyB0pressed=true;}; // 1 
          if (!(keyPressed&Bit2)) {_newENDstep=3;keyB0pressed=true;}; // 2
          if (!(keyPressed&Bit3)) {_newENDstep=7;keyB0pressed=true;}; // 3
          if (!(keyPressed&Bit4)) {_newENDstep=15;keyB0pressed=true;}; // 4
          //if (!(keyPressed&Bit5)) {keyB0pressed=true;}; // 5
          //if (!(keyPressed&Bit6)) {keyB0pressed=true;}; // 6
          //if (!(keyPressed&Bit7)) {keyB0pressed=true;}; // 7
        }      
      }else keyB0pressed=false;
      
      
      
      keyPressed = GetKeyMatrix(2);
      if (keyPressed!=0xFF)
      {
        if(keyB2pressed==false)
        {
          //if (!(keyPressed&Bit0)) {keyB2pressed=true;}; // '
          //if (!(keyPressed&Bit1)) {keyB2pressed=true;}; // £
          if (!(keyPressed&Bit2)) {upNotePattern();keyB2pressed=true;}; // ,/<
          if (!(keyPressed&Bit3)) {downNotePattern();keyB2pressed=true;};   // ./>
          //if (!(keyPressed&Bit4)) {keyB2pressed=true;}; // /
          //if (!(keyPressed&Bit5)) {keyB2pressed=true;}; // DEAD
          //if (!(keyPressed&Bit6)) {keyB2pressed=true;}; // A
          //if (!(keyPressed&Bit7)) {keyB2pressed=true;}; // B
        }      
      }else keyB2pressed=false;
      
      
      
      keyPressed = GetKeyMatrix(6);
      if (keyPressed!=0xFF)
      {
        if(keyB6pressed==false)
        {
          if (!(keyPressed&Bit0)) {CopyPrevPatterns();genTonePattern();keyB6pressed=true;}; // SHIFT
          if (!(keyPressed&Bit1)) {CopyPrevPatterns();genDrumPattern();keyB6pressed=true;}; // CTRL
          //if (!(keyPressed&Bit2)) {keyB6pressed=true;}; // GRAPH
          //if (!(keyPressed&Bit3)) {keyB6pressed=true;}; // CAPS
          //if (!(keyPressed&Bit4)) {keyB6pressed=true;}; // CODE
          if (!(keyPressed&Bit5)) {invertDrumChannel();keyB6pressed=true;}; // F1
          if (!(keyPressed&Bit6)) {invertToneChannel();keyB6pressed=true;}; // F2
          //if (!(keyPressed&Bit7)) {keyB6pressed=true;}; // F3
        }      
      }else keyB6pressed=false;
      
      
     
      
      keyPressed = GetKeyMatrix(7);
      if (keyPressed!=0xFF)
      {
        if(keyB7pressed==false)
        {
          //if (!(keyPressed&Bit0)) {keyB7pressed=true;}; // F4
          //if (!(keyPressed&Bit1)) {keyB7pressed=true;}; // F5
          //if (!(keyPressed&Bit2)){}; // ESC
          if (!(keyPressed&Bit3)) {CopyPrevPatterns();genDrumPattern();genTonePattern();keyB7pressed=true;}; // TAB
          if (!(keyPressed&Bit4)) {Stop();keyB7pressed=true;}; // STOP
          if (!(keyPressed&Bit5)) {RestorePrevPatterns();keyB7pressed=true;}; // BS
          if (!(keyPressed&Bit6)) 
          {
            _isCasio=!_isCasio;
            SetDrumKit(_isCasio);
            switcher(GUI_CASIO_VADDR,_isCasio);
            keyB7pressed=true;
          }; // SELECT
          if (!(keyPressed&Bit7)) {Play();keyB7pressed=true;}; // RETURN
        }
      }else keyB7pressed=false;
      
   
      keyPressed = GetKeyMatrix(8);
      if (keyPressed!=0xFF)
      {
        if(keyB8pressed==false)
        {
          //if (!(keyPressed&Bit0)) {keyB8pressed=true;}; // Space
          if (!(keyPressed&Bit1)) {Help();keyB8pressed=true;}; // Home
          if (!(keyPressed&Bit2)) {upOctave();keyB8pressed=true;}; // Ins
          if (!(keyPressed&Bit3)) {downOctave();keyB8pressed=true;}; // Del
          //if (!(keyPressed&Bit4)) {keyB8pressed=true;}; // Left
          //if (!(keyPressed&Bit5)) {keyB8pressed=true;}; // Up
          //if (!(keyPressed&Bit6)) {keyB8pressed=true;}; // Down
          //if (!(keyPressed&Bit7)) {keyB8pressed=true;}; // Right
        }      
      }else keyB8pressed=false;      
            
    }// Infinite loop
    

}



void checkMSX(void) 
{
  
  // identifica modelo de MSX
  //0 - MSX1, 1 - MSX2, 2 - MSX2+, 3 - TR, 4 - OCM
  VDP_type = PEEK(0x2D);

  
//2BH b7	   Periodo de sincronismo (VSYNC) 0:60Hz	1:50Hz   
/*  
  ld a,($ffe8)
	bit 1,a
	jr z,its_60hz
	
	;its_50Hz
	
its_60hz:
	
	*/

   
}



void initGUI()
{    
    VPrintNumber(8,4, _tempo, 1); 
    
    showSpeaker(GUI_DRUM_VADDR,_DrumEnabled);     
    showSpeaker(GUI_TONE_VADDR,_ToneEnabled);
    
    switcher(GUI_CASIO_VADDR,_isCasio);
    
    switcher(GUI_ABMIX_VADDR,_AB_MIX);
    VPrintNumber(6,15, _AB_offset, 3);
        
    showEnv(_env_index);
    VPrintNumber(8,17, _env_speed, 1);
    switcher(GUI_ENVLOOP_VADDR,envelope_list[_env_index].isLoop);
    
    showOctave();
    
    ShowPattern();            
    
    VPOKE(vaddr_cursor[_cursor_pos],GUI_CURSOR);
}



void ShowSequenceCursor()
{
  // cursor de patron
  VPOKE(GUI_SEQ_VADDR+_last_step,GUI_EMPTY_BLACK);    //borra la ultima posicion del
  VPOKE(GUI_SEQ_VADDR+_pattern_step,GUI_SEQCURSOR);  //muestra el cursor
  _last_step = _pattern_step;
}        



/*void setChannelsState(boolean state)
{
    _DrumEnabled=state;     
    _ToneEnabled=state;    
    showSpeaker(GUI_DRUM_VADDR,state);
    showSpeaker(GUI_TONE_VADDR,state);
}*/



void invertDrumChannel()
{
    _DrumEnabled=!_DrumEnabled;              
    showSpeaker(GUI_DRUM_VADDR,_DrumEnabled); 
}



void invertToneChannel()
{
    _ToneEnabled=!_ToneEnabled;
    showSpeaker(GUI_TONE_VADDR,_ToneEnabled);
}




void PlayerInit()
{
    _tempo = 4;
    _AB_offset = 3;
    _env_index=0;
    _env_speed=1;
    _env_step=0;
    _octave=2;
    
    _tempoStep = _tempo;
    _pattern_step=0;
    _last_step=0;
    _ENDstep = 15;  //to control the size of the pattern
    _newENDstep = 15; 
    
    FillRAM((uint) AYREGS,14,0);  //borra el area del buffer de registros del PSG
}



/*
Decode a frame from song. 
Write AY registers values to buffer 
*/
void PlayerDecode()
{
    char drum_type;
    char tone_note;
    
    uint freqA;
    uint freqB;
        
    
    
    if (_tempoStep>=_tempo) //control de tempo por ciclos de Vblank 
    {
      _tempoStep=0;
      
      /* cursor de patron
      VPOKE(0x1AAE+last_step,239);    //borra la ultima posicion
      VPOKE(0x1AAE+pattern_step,185); //muestra el cursor
      last_step = pattern_step;
      */ 
      
      
      // control de la percusion
      if(_DrumEnabled==true)
      {
        drum_type = drum_pattern[_pattern_step];
        
        if(drum_type>0) //0 = there is no drum
        {
          //if(_isCasio==true) _tmp_INST= &Percu_casio[drum_type-1];
          //else _tmp_INST= &Percu_basic[drum_type-1];
          
          _Drum=&_DrumKit[drum_type-1];
          
          SetMixer(2,_Drum->isTone,_Drum->isNoise);
          AYREGS[4]  = _Drum->Tone & 0xFF;      
          AYREGS[5]  = (_Drum->Tone & 0xFF00)/255;      
          AYREGS[6]  = _Drum->Noise; //noise
          AYREGS[10] = 16; //volumen canal C (16=envolvente)
          AYREGS[11] = _Drum->Period & 0xFF;      
          AYREGS[12] = (_Drum->Period & 0xFF00)/255;
          AYREGS[13] = _Drum->Shape; //envelope wave form   
                      
        }else{
          // there is no drum
          //POKE(AYREGS+10,0); //volumen canal C          
        }
      }     
      

      // control del intrumento de acompañamiento
      tone_note = tone_pattern[_pattern_step];
      if(tone_note>0)
      {
        freqA = getFreq(tone_note+(_octave*12)); //+ variacion;
        freqB = freqA + _AB_offset;
        //VPrintNumber(20,0, tone_note, 3);   // TEST ##########################
        //VPrintNumber(24,0, freq1, 5);
        
        AYREGS[0] = freqA & 0xFF;      
        AYREGS[1] = (freqA & 0xFF00)/255;
        AYREGS[2] = freqB & 0xFF;      
        AYREGS[3] = (freqB & 0xFF00)/255;
        
        _env_step=0;          
      }
      
             
      // control de posicion de pattern
      _pattern_step++;
      if(_pattern_step>_ENDstep)
      {
        _pattern_step=0;
        _ENDstep = _newENDstep;
      } 
      
    }else{
      _tempoStep++;
      //AYREGS[13]=0; //envelope wave form 
      //drum_type=0;    
    }
    
    
    
    //control de volumen del tono (envolvente) ###############################
    if (_ToneEnabled==true)
    {        
      _toneAmp = envelope_list[_env_index].ampValues[_env_step];        
    }else{
      _toneAmp = 0;
    }      
    
    // calcula siguiente posicion.
    _env_step+=_env_speed;
    
    if (_env_step>15) //control de tamaño de envolvente
    {
      if (envelope_list[_env_index].isLoop==true) _env_step=0;
      else _env_step=15; // ultimo valor de la envolvente
    }
    
    AYREGS[8] = _toneAmp;
    
    if(_AB_MIX==true) AYREGS[9] = _toneAmp;
    else AYREGS[9] = 0;


}



// vuelca desde una area de la RAM (AYREGS), 
// los valores de los registros del PSG
// a tres diferentes chips (AY interno, AY Pazos y SCC)
void PlayAY()
{
__asm
  ld HL,#_AYREGS ; direccion de memoria del buffer	

  ld   A,(#_AYREGS+7)
  AND  #0b00111111
  ld   B,A
      
  ld   A,#7
  out  (#AY0index),A
  in   A,(#AY0read) ; read mixer register value 
  and  #0b11000000  ; Mascara para coger dos bits de joys 
  or   B            ; Añado Byte de B
  
  ld   (#_AYREGS+7),A
	
  ld   A,(#__playerHardware) ;//indica que chip utiliza (0=AY interno, 1=AY MEGAFLASHROM)
  or   A
  jr   Z,PSGinternal

;MEGAFLASHROM FPGA AY
  xor A
  ld   C,#0x10
  jr   ILOOP
  
PSGinternal:
  xor A	
  ld   C,#AY0index  ; MSX Internal PSG
  
ILOOP:
  out  (C),A
  inc  C
  outi
  dec  C
  inc  A
  cp   #13  
  jr   NZ,ILOOP
  
  out  (C),A
  ld   A,(HL)
  or   A
  ret  Z
  
  inc  C
  out  (C),A 
  
  ;xor  A
  ld   (HL),#0
    
  ret  

__endasm;
}




// activa tono y ruido de uno de los tres canales del PSG
void SetMixer(char NumChannel, boolean isTone, boolean isNoise)
{
  char newValue;
  
  newValue = AYREGS[7]; //GetSound(7);
  
  if(NumChannel==0) 
  {
      if(isTone==true){newValue&=254;}else{newValue|=1;}
      if(isNoise==true){newValue&=247;}else{newValue|=8;}
  }
  if(NumChannel==1)    
  {
      if(isTone==true){newValue&=253;}else{newValue|=2;}
      if(isNoise==true){newValue&=239;}else{newValue|=16;}
  }
  if(NumChannel==2)
  { 
      if(isTone==true){newValue&=251;}else{newValue|=4;}
      if(isNoise==true){newValue&=223;}else{newValue|=32;}
  }
  //sound_set(7,newValue);
  AYREGS[7] = newValue;
}



void SetDrumKit(boolean kit)
{

    if (kit==false)
    {
      // Instrumentos percusion default Kit
      // Kick
      _DrumKit[0].isTone=true;
      _DrumKit[0].isNoise=false;
      _DrumKit[0].Tone=1700;
      _DrumKit[0].Noise=0;
      _DrumKit[0].Shape=1;
      _DrumKit[0].Period=800;
      
      // Snare
      _DrumKit[1].isTone=true;
      _DrumKit[1].isNoise=true;
      _DrumKit[1].Tone=1000;
      _DrumKit[1].Noise=0;
      _DrumKit[1].Shape=1;
      _DrumKit[1].Period=1400;
      
      // Hi
      _DrumKit[2].isTone=false;
      _DrumKit[2].isNoise=true;
      _DrumKit[2].Tone=0;
      _DrumKit[2].Noise=0;
      _DrumKit[2].Shape=1;
      _DrumKit[2].Period=400;  //200
    
    }else{
      // Instrumentos percusion - Kit PT1
      // Kick
      _DrumKit[0].isTone=true;
      _DrumKit[0].isNoise=false;
      _DrumKit[0].Tone=140;
      _DrumKit[0].Noise=0;
      _DrumKit[0].Shape=1;
      _DrumKit[0].Period=800;
      
      // Snare
      _DrumKit[1].isTone=false;
      _DrumKit[1].isNoise=true;
      _DrumKit[1].Tone=0;
      _DrumKit[1].Noise=0;
      _DrumKit[1].Shape=1;
      _DrumKit[1].Period=1600;
      
      // Hi
      _DrumKit[2].isTone=true;
      _DrumKit[2].isNoise=false;
      _DrumKit[2].Tone=66;
      _DrumKit[2].Noise=0;
      _DrumKit[2].Shape=1;
      _DrumKit[2].Period=400;    
    }

}



void Silence()
{
__asm  
  call GICINI   ;Init PSG
__endasm;
}



void Play()
{
    _tempoStep = _tempo;
    _pattern_step=0;
    ShowSequenceCursor();
    //setChannelsState(true);
    _playerStatus=PLAYER_PLAY;
}



void Stop()
{
    AYREGS[8]=0;
    AYREGS[9]=0;
    AYREGS[10]=0;
    _playerStatus=PLAYER_STOP;
}




// genera un valor aleatorio de 8 bits y le aplica una máscara
// necesita de un char en la RAM (SEED)
char Rnd(char value) __naked
{
value;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   C,4(ix) ;recoge el valor de la mascara  	
  
  ld   A,R		;  
  ld	 B,A
  
  ld   A,(#_SEED)
  SRA  A
  
	add	 A,B		
	;add	A,A
	
	ld   B,A
	
	ld   A,R		;  
	add	 A,B
	
	inc	 A
  
  ld   (#_SEED),A
    
  AND  C  ;aplica la mascara     
  
  
  ld   L,A
  pop  IX
  
  ret   
__endasm;
}



void pressKey()
{
__asm   
    call CHGET
__endasm;
}



void CopyPrevPatterns()
{
  char i;
  
  for(i=0;i<16;i++)
  {
    prev_drum_pattern[i] = drum_pattern[i]; //copy pattern
    prev_tone_pattern[i] = tone_pattern[i];
  }
}




void RestorePrevPatterns()
{
  char i;
  char drum;
  char tone;
  
  uint vaddrDrum = GUI_SEQ_DRUM_VADDR;
  uint vaddrTone = GUI_SEQ_TONE_VADDR;
    
  for(i=0;i<16;i++)
  {
    drum = drum_pattern[i];
    tone = tone_pattern[i];
       
    drum_pattern[i]=prev_drum_pattern[i];
    tone_pattern[i]=prev_tone_pattern[i];
    
    prev_drum_pattern[i] = drum;
    prev_tone_pattern[i] = tone;
    
    VPOKE(vaddrDrum++,drum_pattern[i]+GUI_SEQ_INSTR); //draw drum
    
    //draw tone
    if(tone_pattern[i]==0) VPOKE(vaddrTone++,GUI_SEQ_INSTR);
    else VPOKE(vaddrTone++,GUI_SEQ_TONE);    
  }
}



// genera un patron de ritmo de forma aleatoria
void genDrumPattern()
{
  char hits;
  char kicks;
  char snares;
  char conta=0;
  char increment=0;
  uint vaddr = GUI_SEQ_DRUM_VADDR;
  
  char i;  
  
  
  for(i=0;i<16;i++) drum_pattern[i]=0;
  
  hits=Rnd(3);  
  if(hits>0)
  {
    //hits++;
    do{
      conta+=hits;
      if(conta<16) drum_pattern[conta]=3;       
    }while(conta<16); 
  }
  
  conta=0;
  kicks=Rnd(3)*2;
  if(kicks>0)
  {
    do{      
      drum_pattern[conta]=1;
      conta+=kicks;       
    }while(conta<16); 
  }
  
  conta=0;
  snares=Rnd(3)*4;
  if(snares>0)
  {
    do{
      conta+=snares;
      if(conta<16) drum_pattern[conta]=2;       
    }while(conta<16); 
  }
  
  ShowDrumPattern();
  
}



// genera un patron de tono de forma aleatoria
void genTonePattern()
{
  char type;
  char value;
  char conta=0;
  char increment=0;
  
  char i;
  
  
  for(i=0;i<16;i++) tone_pattern[i]=0;
  
  type=Rnd(3)+1; 
  if (type==1) increment=0;
  if (type==2) increment=4;
  if (type>2) increment=2;
   
  type++;
  for(i=1;i<type;i++)
  {
    value=Rnd(15);
    if(value>11) value=0;
    tone_pattern[conta]=value+1;
    conta=conta+increment;
  }
  
  //copy first 8 steps sequence to next 8 steps 
  for(i=0;i<8;i++) tone_pattern[i+8]=tone_pattern[i];
  
  ShowTonePattern();
    
  return;
}



void ShowPattern()
{
    ShowDrumPattern();
    ShowTonePattern();
}


 //draw in screen a Drum pattern
void ShowDrumPattern()
{
  uint vaddr = GUI_SEQ_DRUM_VADDR;
  char i;
  
  for (i=0;i<16;i++) VPOKE(vaddr++,drum_pattern[i]+GUI_SEQ_INSTR);
  
}



 //draw in screen a Tone pattern
void ShowTonePattern()
{
  uint vaddr = GUI_SEQ_TONE_VADDR;
  char i;
  
  for (i=0;i<16;i++){
    if(tone_pattern[i]==0) VPOKE(vaddr++,GUI_SEQ_INSTR);
    else VPOKE(vaddr++,GUI_SEQ_TONE);
  }
}



void upOctave()
{
  if (_octave>1) _octave--;
  showOctave();
}



void downOctave()
{
   if (_octave<6) _octave++;
   showOctave();
}



void showOctave()
{
    VPrintNumber(8,19, _octave, 1);
}



// sube una nota el patron de tono
void downNotePattern()
{
  char i;
  char value;
  
  for(i=0;i<16;i++)
  {
    value = tone_pattern[i];
    if(value>0 && value<96) tone_pattern[i]=value+1;
  }
  
  return;  
}



// baja una nota el patron de tono
void upNotePattern()
{
  char i;
  char value;
  
  for(i=0;i<16;i++)
  {
    value = tone_pattern[i];
    if(value>1) tone_pattern[i]=value-1;
  }
  
  return;  
}



// proporciona la frecuencia a partir de un numero de nota
// A=num de nota (0>96) HL=valor freq
int getFreq(char value) __naked
{
value;
__asm 
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld A,4(IX)  

;GETFREQ:  
  SLA A    ; x2 (rotacion izquierda sin acarreo) 
  ld D,#0
  ld E,A
  ld IY,#VNOTAS
  add IY,DE
  
  ld L,(IY)
  ld H,1(IY)
  
  pop IX
  ret

VNOTAS:				
  .dw 0
	; Octava 0 (0)
  .dw 0x0D5D,0x0C9C,0x0BE7,0x0B3C,0x0A9B,0x0A02,0x0973,0x08EB,0x086B,0x07F2,0x0780,0x0714 
	; Octava 1 (24)
	.dw	0x06AE,0x064E,0x05F4,0x059E,0x054D,0x0501,0x04B9,0x0475,0x0435,0x03F9,0x03C0,0x038A
	; Octava 2 (48)
	.dw	0x0357,0x0327,0x02FA,0x02CF,0x02AF,0x0281,0x025D,0x023B,0x021B,0x01FC,0x01E0,0x01C5
	; Octava 3 (72)
	.dw	0x01AC,0x0194,0x017D,0x0168,0x0153,0x0140,0x012E,0x011D,0x010D,0x00FE,0x00F0,0x00E2
	; Octava 4 (96)
	.dw	0x00D6,0x00CA,0x00BE,0x00B4,0x00AA,0x00A0,0x0097,0x008F,0x0087,0x007F,0x0078,0x0071
	; Octava 5 (120)
	.dw	0x006B,0x0065,0x005F,0x005A,0x0055,0x0050,0x004C,0x0047,0x0043,0x0040,0x003B,0x0039
	; Octava 6 (144)
	.dw	0x0035,0x0032,0x0030,0x002D,0x002A,0x0028,0x0026,0x0024,0x0022,0x0020,0x001E,0x001C
	; Octava 7 (168)
	.dw	0x001B,0x0019,0x0018,0x0016,0x0015,0x0014,0x0013,0x0012,0x0011,0x0010,0x000F,0x000E

__endasm;
}



/* =============================================================================
 It provides the address of the video memory map tiles, from the screen position
 indicated.
 Proporciona la direccion de la memoria de video del mapa de tiles, a partir de
 la posicion de pantalla indicada.
 Inputs:
   column (char) 0 - 31
   line (char) 0 - 23
============================================================================= */
uint GetVAddressByPosition(char column, char line)
{
   return BASE10 + (line*32)+column;
}



void VPRINT(char column, char line, char* text)
{
  unsigned int vaddress = GetVAddressByPosition(column, line);
  while(*(text)) VPOKE(vaddress++,*(text++));
}



void VPrintNumber(char posx, char posy, uint aNumber, char aLength)
{
  char pos=5;
  uint tiladdre=0;

  char strBuff[]="     ";    

  num2Dec16(aNumber, strBuff);
  
  // proporciona la direccion de la VRAM a partir de una posicion
  tiladdre = GetVAddressByPosition(posx, posy);
  
  //coloca el puntero en la posicion donde se ha de empezar a mostrar 
  pos = 5-aLength;
  
  // muestra el numero en la pantalla
  while (aLength-->0){ VPOKE(tiladdre++,strBuff[pos++]);}
}



void num2Dec16(uint aNumber, char *address)
{
  aNumber;
  address;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   L,4(ix)
  ld   H,5(ix)
  
  ld   E,6(ix)
  ld   D,7(ix)
  	
  ld   BC,#-10000
	call $Num1
	ld   BC,#-1000
	call $Num1
	ld   BC,#-100
	call $Num1
	ld   C,#-10
	call $Num1
	ld   C,B
	call $Num1
  jr   $Num3  
$Num1:	
  ld   A,#-1 ;ASCII-1 47 
$Num2:	
  inc	 A
	add	 HL,BC
	jr	 C,$Num2
	sbc	 HL,BC
	ld	 (DE),A
	inc	 DE
	ret
$Num3:	
  ;END
  pop  IX
  
__endasm;
}



// muestra un control tipo switch (interruptor)
void switcher(uint vaddr, boolean value)
{
  if(value==true)
  {
    VPOKE(vaddr++,GUI_SWITCHER_ON);
    VPOKE(vaddr,GUI_SWITCHER);
  }else{
    VPOKE(vaddr++,GUI_SWITCHER);
    VPOKE(vaddr,GUI_SWITCHER_OFF);  
  }
  return;
}



// muestra el valor de la envolvente
void showEnv(char value)
{
  VPrintNumber(8,16, value, 3);
  value=value*2+192;
  VPOKE(0x1A06,value++);
  VPOKE(0x1A07,value++);
}



// muestra el indicador de activación de canal de audio (altavoz)
void showSpeaker(uint vaddr, boolean value)
{
  if(value==true) VPOKE(vaddr,GUI_SPEAKER_ON);
  else VPOKE(vaddr,GUI_SPEAKER_OFF);
    
  return;
}




void initHelpText() __naked
{
__asm

  ld   HL,#HELP_TEXT
  ld   DE,#_HELP_TXTADDR
  jp   unRLEWBRAM
  

; map size width:29 height:35
; RLE WB compressed - Original size= 1015 - Compress size= 790
HELP_TEXT:
.db 0x4B,0x65,0x79,0x20,0x4C,0x69,0x73,0x74,0x80,0x14,0x20,0x80,0x1C,0x2D,0x8D,0x81
.db 0x89,0x8E,0x20,0x93,0x83,0x92,0x85,0x85,0x8E,0x9B,0x80,0x10,0x20,0x2D,0x5B,0x55
.db 0x70,0x5D,0x20,0x4D,0x65,0x6E,0x75,0x20,0x63,0x75,0x72,0x73,0x6F,0x72,0x20,0x75
.db 0x70,0x80,0x08,0x20,0x2D,0x5B,0x44,0x6F,0x77,0x6E,0x5D,0x20,0x4D,0x65,0x6E,0x75
.db 0x20,0x63,0x75,0x72,0x73,0x6F,0x72,0x20,0x64,0x6F,0x77,0x6E,0x80,0x04,0x20,0x2D
.db 0x5B,0x4C,0x65,0x66,0x74,0x5D,0x20,0x53,0x77,0x69,0x74,0x63,0x68,0x20,0x6C,0x65
.db 0x66,0x74,0x20,0x6F,0x72,0x80,0x07,0x20,0x64,0x65,0x63,0x72,0x65,0x61,0x73,0x65
.db 0x20,0x76,0x61,0x6C,0x75,0x65,0x2E,0x80,0x0C,0x20,0x2D,0x5B,0x52,0x69,0x67,0x68
.db 0x74,0x5D,0x20,0x53,0x77,0x69,0x74,0x63,0x68,0x20,0x72,0x69,0x67,0x68,0x74,0x20
.db 0x6F,0x72,0x80,0x05,0x20,0x69,0x6E,0x63,0x72,0x65,0x61,0x73,0x65,0x20,0x76,0x61
.db 0x6C,0x75,0x65,0x2E,0x80,0x0C,0x20,0x2D,0x5B,0x53,0x50,0x41,0x43,0x45,0x5D,0x20
.db 0x6F,0x72,0x20,0x4A,0x6F,0x79,0x73,0x74,0x69,0x63,0x6B,0x20,0x42,0x75,0x74,0x74
.db 0x6F,0x6E,0x80,0x02,0x20,0x41,0x63,0x74,0x75,0x61,0x74,0x65,0x20,0x74,0x68,0x65
.db 0x20,0x72,0x61,0x6E,0x64,0x6F,0x6D,0x20,0x62,0x75,0x74,0x74,0x6F,0x6E,0x73,0x80
.db 0x02,0x20,0x6F,0x72,0x20,0x74,0x68,0x65,0x20,0x73,0x77,0x69,0x74,0x63,0x68,0x65
.db 0x72,0x73,0x2E,0x80,0x0A,0x20,0x2D,0x5B,0x52,0x45,0x54,0x55,0x52,0x4E,0x5D,0x20
.db 0x50,0x6C,0x61,0x79,0x62,0x61,0x63,0x6B,0x20,0x6D,0x6F,0x64,0x65,0x80,0x05,0x20
.db 0x2D,0x5B,0x53,0x54,0x4F,0x50,0x5D,0x20,0x53,0x74,0x6F,0x70,0x20,0x70,0x61,0x74
.db 0x74,0x65,0x72,0x6E,0x20,0x70,0x6C,0x61,0x79,0x62,0x61,0x63,0x6B,0x2D,0x5B,0x46
.db 0x31,0x5D,0x9D,0x52,0x68,0x79,0x74,0x68,0x6D,0x20,0x63,0x68,0x61,0x6E,0x6E,0x65
.db 0x6C,0x20,0x4F,0x6E,0x2F,0x4F,0x66,0x66,0x20,0x20,0x2D,0x5B,0x46,0x32,0x5D,0x9C
.db 0x4D,0x65,0x6C,0x6F,0x64,0x79,0x20,0x63,0x68,0x61,0x6E,0x6E,0x65,0x6C,0x20,0x4F
.db 0x6E,0x2F,0x4F,0x66,0x66,0x20,0x20,0x2D,0x5B,0x54,0x41,0x42,0x5D,0x20,0x52,0x61
.db 0x6E,0x64,0x6F,0x6D,0x20,0x52,0x68,0x79,0x74,0x68,0x6D,0x20,0x26,0x20,0x4D,0x65
.db 0x6C,0x6F,0x64,0x79,0x2D,0x5B,0x43,0x54,0x52,0x4C,0x5D,0x20,0x52,0x61,0x6E,0x64
.db 0x6F,0x6D,0x20,0x52,0x68,0x79,0x74,0x68,0x6D,0x20,0x70,0x61,0x74,0x74,0x65,0x72
.db 0x6E,0x2D,0x5B,0x53,0x48,0x49,0x46,0x54,0x5D,0x52,0x61,0x6E,0x64,0x6F,0x6D,0x20
.db 0x4D,0x65,0x6C,0x6F,0x64,0x79,0x20,0x70,0x61,0x74,0x74,0x65,0x72,0x6E,0x2D,0x5B
.db 0x31,0x5D,0x20,0x4C,0x6F,0x6F,0x70,0x20,0x66,0x69,0x72,0x73,0x74,0x20,0x32,0x20
.db 0x73,0x74,0x65,0x70,0x73,0x80,0x05,0x20,0x2D,0x5B,0x32,0x5D,0x20,0x4C,0x6F,0x6F
.db 0x70,0x20,0x66,0x69,0x72,0x73,0x74,0x20,0x34,0x20,0x73,0x74,0x65,0x70,0x73,0x80
.db 0x05,0x20,0x2D,0x5B,0x33,0x5D,0x20,0x4C,0x6F,0x6F,0x70,0x20,0x66,0x69,0x72,0x73
.db 0x74,0x20,0x38,0x20,0x73,0x74,0x65,0x70,0x73,0x80,0x05,0x20,0x2D,0x5B,0x34,0x5D
.db 0x20,0x52,0x65,0x73,0x74,0x6F,0x72,0x65,0x20,0x74,0x6F,0x20,0x31,0x36,0x20,0x73
.db 0x74,0x65,0x70,0x73,0x80,0x04,0x20,0x2D,0x5B,0x42,0x53,0x5D,0x20,0x50,0x6C,0x61
.db 0x79,0x20,0x70,0x72,0x65,0x76,0x69,0x6F,0x75,0x73,0x20,0x70,0x61,0x74,0x74,0x65
.db 0x72,0x6E,0x20,0x20,0x2D,0x5B,0x53,0x45,0x4C,0x45,0x43,0x54,0x5D,0x20,0x44,0x72
.db 0x75,0x6D,0x20,0x6B,0x69,0x74,0x3A,0x20,0x53,0x74,0x61,0x6E,0x64,0x61,0x72,0x64
.db 0x20,0x20,0x6F,0x72,0x20,0x43,0x61,0x73,0x69,0x6F,0x20,0x50,0x54,0x80,0x10,0x20
.db 0x2D,0x5B,0x49,0x6E,0x73,0x5D,0x20,0x4F,0x63,0x74,0x61,0x76,0x65,0x20,0x55,0x70
.db 0x80,0x0C,0x20,0x2D,0x5B,0x44,0x65,0x6C,0x5D,0x20,0x4F,0x63,0x74,0x61,0x76,0x65
.db 0x20,0x44,0x6F,0x77,0x6E,0x80,0x0A,0x20,0x2D,0x5B,0x2C,0x5D,0x20,0x4E,0x6F,0x74
.db 0x65,0x20,0x55,0x70,0x80,0x10,0x20,0x2D,0x5B,0x2E,0x5D,0x20,0x4E,0x6F,0x74,0x65
.db 0x20,0x44,0x6F,0x77,0x6E,0x80,0x2B,0x20,0x88,0x85,0x8C,0x90,0x20,0x93,0x83,0x92
.db 0x85,0x85,0x8E,0x9B,0x80,0x10,0x20,0x2D,0x5B,0x55,0x70,0x5D,0x20,0x55,0x70,0x20
.db 0x73,0x63,0x72,0x6F,0x6C,0x6C,0x20,0x74,0x65,0x78,0x74,0x80,0x08,0x20,0x2D,0x5B
.db 0x44,0x6F,0x77,0x6E,0x5D,0x20,0x44,0x6F,0x77,0x6E,0x20,0x73,0x63,0x72,0x6F,0x6C
.db 0x6C,0x20,0x74,0x65,0x78,0x74,0x80,0x04,0x20,0x2D,0x5B,0x45,0x53,0x43,0x5D,0x20
.db 0x52,0x65,0x74,0x75,0x72,0x6E,0x20,0x74,0x6F,0x20,0x6D,0x61,0x69,0x6E,0x20,0x73
.db 0x63,0x72,0x65,0x65,0x6E,0x20,0x80,0xFF
  
__endasm;
}



void Help()
{
  boolean isExit = false;
  
  boolean joybool = false;
  boolean joytrigbool = true;
  char joyval;
  char joytrig;
  
  char helpLinePos=0;

  
  Silence(); //Enjoy the...
  
  SetSpriteVisible(0,false);
  SetSpriteVisible(1,false);
  
  FillVRAM(BASE10, 768, 255); //clear screen
  
  if (VDP_type>0) SetPalette(2);
  
  showHelpScr();
  
  VPRINT(23,1,app_version);
  
  showHelpText(0);
  showScrollbar(0);
  
  //SetSpritePattern(0, 31);
  //SetSpritePattern(1, 31);

    
  while(isExit==false)
  {
    HALT;
    
    joytrig=STRIG(1);
    if (joytrig==0) joytrig=STRIG(2);
    if (joytrig>0)
    {
      if (joytrigbool==false)
      {
        //joytrigbool = true;
        isExit=true;
      }
    }else{
        joytrigbool = false;
    }
    
    if (!(GetKeyMatrix(7)&Bit2)) isExit=true; // ESC
    
    joyval=STICK(0);
    if (joyval==0) joyval=STICK(1);
    if (joyval==0) joyval=STICK(2);
    if (joyval>0)
    {
      if (joybool==false)
      {
        joybool = true;
        
        if(joyval==1) // arriba
        {            
          if(helpLinePos>0) {helpLinePos--;showHelpText(helpLinePos);showScrollbar(helpLinePos);}
        }
        if(joyval==5) // abajo
        {            
          if(helpLinePos<(HELP_LINES-20)) {helpLinePos++;showHelpText(helpLinePos);showScrollbar(helpLinePos);}           
        }
        //if(joyval==3) // right
        //if(joyval==7) // left
      }
    }else{
      joybool = false;
    }  
      
  }
  
  //FillVRAM(BASE10, 768, 255); //clear screen
  if (VDP_type>0) SetPalette(1);
  showMainScr();
  initGUI();
  
/*
  
  
  VPRINT(RNAME_X,RNAME_Y,_rhythm->name);
  VPrintNumber(TEMPO_X,TEMPO_Y, _tempo, 2);
  
  setPattern();
  
  WAIT(30); //

  SetSpritePattern(0, 7);
  SetSpritePattern(1, 7);
*/
  
}



void showHelpText(char line) __naked
{
line;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   E,4(IX)    ;<--- line number
  ld   D,#0
  
  ld   BC,#HELP_WIDTH
  
  call Mult16  ; HL = BC*DE 
  ld   DE,#_HELP_TXTADDR
  add  HL,DE
  
  ld   DE,#BASE10 + (3*32)+1  ;VRAM address

  ld   B,#20
printAline:
  push BC
  push HL
  push DE  
  
  ld   BC,#HELP_WIDTH  ; line size 
  call LDIRVM

  pop  DE
  ex   DE,HL
  ld   DE,#32
  add  HL,DE
  ex   DE,HL
  
  pop  HL
  ld   BC,#HELP_WIDTH
  add  HL,BC  
  
  pop  BC
  djnz printAline

  pop  IX
  ret
  
;
; Multiply 16-bit values (with 16-bit result)
; In: Multiply BC with DE
; Out: HL = result
;
Mult16:
    ld   A,B
    ld   B,#16
Mult16_Loop:
    add  HL,HL
    sla  C
    rla
    jr   NC,Mult16_NoAdd
    add  HL,DE
Mult16_NoAdd:
    djnz Mult16_Loop
    ret  
  
__endasm;
}



void showScrollbar(char line)
{
    char i;
    uint vaddr = 0x187F;
    char barrPos;
    //char temp;
    boolean writeBar;
    
    //temp = (20/30)*8;
    barrPos =(line<<4)>>1;
    barrPos = barrPos>>4;
    
    //VPrintNumber(26,0, temp, 4);

    char size=0;
    
    for (i=0;i<20;i++)
    {
        if(i>=barrPos){
          if(size<HELP_sizeBar)
          {
            writeBar=true;
            size++;
          } 
          else writeBar=false;
        }        
        else writeBar=false;
        
        if(writeBar) VPOKE(vaddr,GUI_SCROLLBAR); 
        else VPOKE(vaddr,GUI_SCROLLBAR_EMPTY);
        vaddr+=32;
    }
    
    //HELP_sizeBar = 13;   //(20/HELP_LINES)*20

}



void showLogoScreen() __naked
{
__asm
  ld   HL,#titlescreen_PAT
  ld   DE,#BASE12
  call unRLEWBVRAM
           
  ld   HL,#titlescreen_COL
  ld   DE,#BASE11
  call unRLEWBVRAM

    
  ld   HL,#titlescreen_SPRPATTERNS
  ld   DE,#BASE14
  jp   unRLEWBVRAM
  



; Project: The Alan Random Project (TARP)
; Picture: TARP_titlescreen_BG
; RLE WB compressed - Original size= 6144 - Final size= 1270
titlescreen_PAT:
.db 0x80,0x03,0xFF,0x03,0x03,0x80,0x05,0x00,0xF6,0xF6,0xC7,0xC7,0x80,0x05,0x00,0x87
.db 0xCF,0x80,0x06,0x00,0x80,0x00,0x80,0x03,0x00,0x1C,0x1C,0x36,0x37,0x80,0x03,0x00
.db 0x38,0x38,0x18,0x18,0x80,0x05,0x00,0x39,0x3D,0x80,0x05,0x00,0xE0,0xF0,0x80,0x03
.db 0x00,0x07,0x07,0x06,0x06,0x80,0x03,0x00,0x80,0x00,0x80,0x00,0xC3,0xE3,0x80,0x05
.db 0x00,0x9E,0xDF,0x80,0x03,0x00,0x03,0x03,0x0F,0x1F,0x80,0x05,0x00,0x38,0x7C,0x80
.db 0x05,0x00,0xC4,0xEE,0x80,0x05,0x00,0x70,0xF0,0x80,0x03,0x00,0x80,0x03,0x03,0x80
.db 0x03,0x00,0xC0,0xC0,0x67,0x77,0x80,0x05,0x00,0xC7,0xEF,0x80,0x03,0x00,0x03,0x03
.db 0x00,0x83,0x80,0x05,0x00,0x1C,0x3E,0x80,0x05,0x00,0x38,0x7C,0x80,0x03,0x00,0x30
.db 0x30,0x78,0x78,0x80,0x57,0x00,0x80,0x07,0xC6,0xCD,0x6F,0x6F,0x80,0x02,0x6C,0x6F
.db 0x67,0x80,0x02,0x80,0x00,0x00,0xC0,0xC0,0x80,0x00,0x33,0x3F,0x3F,0x80,0x04,0x33
.db 0x80,0x05,0x18,0x7E,0x7E,0x0D,0x7D,0x7D,0x80,0x02,0xCD,0xFD,0x7D,0xB0,0x80,0x06
.db 0x98,0x80,0x02,0x06,0x07,0x07,0x80,0x02,0x06,0x60,0x67,0x67,0xCC,0xCC,0x8C,0xCF
.db 0xC7,0xDB,0x80,0x06,0xD9,0x1B,0x80,0x04,0xB3,0xBF,0x9F,0x6C,0x80,0x04,0x66,0x7E
.db 0x3C,0x80,0x02,0xFE,0xD6,0xD6,0x80,0x02,0xC6,0xC0,0x78,0x78,0x0C,0x0C,0xCC,0xFC
.db 0x78,0x80,0x07,0x03,0x80,0x02,0x36,0xE6,0xE6,0x80,0x02,0x06,0x6D,0x80,0x04,0x0C
.db 0x0F,0x07,0x83,0x80,0x04,0xC3,0xCB,0x8B,0x36,0x3E,0x3E,0x30,0x30,0x33,0x3F,0x1E
.db 0x64,0x80,0x03,0x60,0x66,0x7E,0x3C,0x80,0x04,0x30,0x34,0x3C,0x18,0x80,0x97,0x00
.db 0x60,0x60,0x80,0x45,0x00,0x06,0x06,0x80,0xFE,0x00,0x80,0xFE,0x00,0x80,0x2D,0x00
.db 0x01,0x03,0x80,0x04,0x00,0x07,0xFF,0xFF,0x80,0x03,0x00,0x80,0x03,0xFF,0x80,0x03
.db 0x00,0x80,0x03,0xFF,0x80,0x04,0x00,0xF0,0xFF,0xFF,0x80,0x06,0x00,0xC0,0x80,0xCA
.db 0x00,0x03,0x07,0x0F,0x1F,0x3F,0x1F,0x3F,0x80,0x25,0xFF,0xF0,0xF8,0xFC,0xFE,0x80
.db 0x03,0xFF,0x80,0x04,0x00,0x80,0x00,0x80,0x00,0xC0,0x80,0xBA,0x00,0x01,0x01,0x03
.db 0x07,0x06,0x7F,0x7F,0x80,0x03,0xFF,0xBF,0x3F,0x80,0x2F,0xFF,0xE0,0xE0,0x80,0x02
.db 0xF0,0xF8,0xF8,0xFC,0x80,0x5B,0x00,0x03,0x0F,0x1F,0x1F,0x80,0x02,0x00,0x70,0xFC
.db 0x80,0x02,0xFF,0x80,0x05,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x07,0x1F,0x3F,0x7F
.db 0x7F,0xFE,0xFF,0xFF,0xE0,0xF8,0xFC,0xFC,0xFE,0x3F,0x80,0x37,0xFF,0x06,0x04,0x04
.db 0x80,0x04,0x08,0xC0,0x80,0x06,0x80,0x80,0x2F,0x00,0x80,0x03,0x03,0x80,0x03,0x01
.db 0x80,0x57,0xFF,0x80,0x04,0xC0,0xE0,0xE0,0xF0,0x00,0x8F,0x80,0x02,0x07,0x8F,0xFF
.db 0x01,0x80,0x03,0x3F,0x7F,0x7F,0xFF,0xFF,0x80,0x02,0xFC,0xFE,0x80,0x00,0xC0,0xE0
.db 0xF0,0x80,0x02,0x1F,0x3F,0x01,0x01,0x03,0x07,0x80,0x37,0xFF,0x08,0x00,0x80,0x03
.db 0x08,0x00,0x08,0x80,0x07,0x80,0x80,0x2F,0x00,0x01,0x80,0x06,0x00,0x80,0x57,0xFF
.db 0x80,0x07,0x01,0x80,0x06,0xFC,0x01,0x80,0x03,0xFF,0x00,0x00,0x7F,0xC1,0x80,0x03
.db 0x07,0x80,0x02,0x0F,0x03,0x0F,0x80,0x02,0x1F,0x3F,0x3F,0xC0,0xC0,0x80,0x37,0x00
.db 0x08,0x00,0x00,0x04,0x04,0x80,0x02,0x00,0x80,0x02,0x80,0x80,0x02,0xC0,0xE0,0xE0
.db 0x80,0x31,0x00,0x80,0x04,0x01,0x03,0x80,0x51,0xFF,0xFC,0xF0,0xE0,0xE0,0xC0,0xC0
.db 0xFC,0xF8,0x70,0x03,0x07,0x0F,0x1F,0x3F,0x02,0x80,0x0E,0x00,0x20,0x80,0x06,0x00
.db 0x3F,0x1C,0xC0,0xE0,0xF0,0xF8,0xF8,0xFC,0xFF,0x1F,0x0F,0x07,0x03,0x03,0x01,0x01
.db 0x80,0x37,0xFF,0x80,0x02,0x0F,0x07,0x07,0x03,0x03,0x01,0x80,0x2F,0xFF,0xFC,0xFC
.db 0xF8,0xF8,0xF0,0xE0,0xC0,0x80,0x00,0x80,0x4F,0x00,0x80,0x03,0xC0,0xE0,0xF8,0xFE
.db 0x01,0x3F,0x7F,0x7F,0x80,0x03,0x80,0x80,0x05,0x00,0xFE,0xFE,0x80,0x06,0xFF,0x7F
.db 0x3F,0x80,0x03,0xFF,0xEF,0xEF,0xCF,0x9F,0xFE,0xFE,0x80,0x02,0x01,0x80,0x02,0x00
.db 0x80,0x02,0x01,0x03,0x07,0x1F,0xC0,0xC0,0x80,0x3F,0x00,0xFF,0x80,0x00,0xE0,0xF0
.db 0xF8,0xFC,0xFF,0xFF,0x80,0x06,0x00,0xF0,0x80,0x0E,0x00,0x01,0x80,0x04,0x00,0x01
.db 0x0F,0xFF,0x00,0x01,0x03,0x0F,0x7F,0x80,0x58,0xFF,0x01,0x1F,0x80,0x03,0x01,0x03
.db 0x1F,0x07,0x3F,0x80,0x0F,0xFF,0x8E,0xE0,0x80,0x05,0xFF,0x3F,0x80,0x0E,0xFF,0xC0
.db 0xC0,0xE0,0xE0,0xFF,0x80,0x00,0x80,0x05,0xFF,0x07,0x00,0xE0,0x01,0x80,0x04,0xFF
.db 0x80,0x00,0xF0,0xFC,0x80,0xA8,0x00,0x01,0x80,0x02,0x03,0x80,0x02,0x07,0x03,0x1F
.db 0x3F,0x7F,0x80,0x00,0x80,0x09,0x00,0xC0,0x80,0x06,0xFF,0x80,0x00,0x80,0x14,0x00
.db 0x09,0x1D,0x14,0x80,0x04,0x00,0x10,0xB0,0xE0,0x80,0x05,0x00,0x3F,0x7F,0x80,0x05
.db 0x00,0xF8,0xFE,0x0F,0x03,0x01,0x01,0x80,0x03,0x00,0xFF,0x80,0x00,0x80,0x00,0x80
.db 0x04,0xC0,0x80,0x9F,0x00,0x80,0x07,0x07,0x80,0x07,0xFF,0x80,0x00,0xF0,0xE0,0x80
.db 0x02,0xC0,0xE0,0xE0,0x80,0x07,0x80,0x80,0x0F,0x00,0x3E,0x22,0x22,0x80,0x04,0x00
.db 0x80,0x02,0x40,0x80,0x04,0x00,0x80,0x07,0xE0,0x0F,0x07,0x80,0x05,0x03,0x80,0x07
.db 0xFF,0x80,0x06,0xC0,0x80,0x00,0x80,0x9F,0x00,0x03,0x03,0x01,0x01,0x80,0x03,0x00
.db 0x80,0x00,0x80,0x00,0xC0,0xE1,0xFF,0xC0,0xFF,0xFF,0x80,0x02,0x0E,0x1E,0x3E,0x7E
.db 0xFE,0xFE,0x80,0x07,0x80,0x80,0x1F,0x00,0x80,0x06,0xE0,0xFC,0x03,0x01,0x01,0x80
.db 0x04,0x00,0x81,0x83,0x01,0x87,0x80,0x03,0xFF,0x7F,0x80,0xB6,0xFF,0x80,0x07,0xFC
.db 0x80,0x00,0x80,0x14,0x00,0xC0,0x80,0x00,0x80,0x05,0xFF,0x07,0x01,0x80,0x07,0xFF
.db 0x01,0x0F,0x07,0x80,0x02,0x03,0x01,0x01,0x80,0x03,0xFF,0x80,0x03,0x80,0x80,0xBF
.db 0x00,0x80,0x07,0x03,0x80,0x04,0xFF,0x80,0x02,0x80,0x00,0x80,0x06,0x01,0xE0,0xC0
.db 0x80,0x05,0x80,0x0F,0x07,0x03,0x03,0x80,0x03,0x01,0xFF,0xFF,0x80,0x05,0x80,0x80
.db 0x07,0x01,0x80,0x07,0x80,0x80,0xA5,0x00,0x01,0x7F,0x80,0x04,0x00,0x1F,0x03,0x80
.db 0x04,0xFF,0x0F,0x01,0x80,0x04,0xFF,0x0F,0x80,0x03,0xFF,0x01,0x00,0x00,0xFF,0x80
.db 0x00,0x80,0x02,0x00,0xC0,0xF0,0x80,0x00,0x00,0x80,0x03,0xFF,0x03,0xC0,0x80,0x0D
.db 0xFF,0x80,0x02,0x01,0xFF,0xFF,0xE0,0xF8,0xFE,0x80,0x05,0x80,0xC0,0xE0,0x80,0x05
.db 0x01,0x03,0x07,0x80,0x04,0x80,0x03,0x07,0x00,0x80,0x05,0xFF,0x01,0x01,0x80,0x06
.db 0xFF,0x01,0x80,0x75,0xFF,0xF8,0xC0,0x80,0x03,0xFF,0xF0,0x07,0x3F,0x80,0x02,0xFF
.db 0x0F,0x0F,0x80,0x03,0xFF,0x0F,0xFF,0x80,0x00,0x80,0x04,0x00,0xE0,0x80,0x3E,0x00
.db 0x01,0x80,0x06,0x00,0x80,0x00,0xC0,0x80,0x00,0x80,0x04,0xFF,0x01,0x07,0x0F,0x80
.db 0x14,0xFF,0xFE,0x80,0x06,0xFF,0x07,0x07,0x80,0x05,0x00,0xFF,0xF0,0xC0,0xFE,0x80
.db 0x05,0xFF,0xC0,0xFE,0x07,0x80,0x02,0x00,0x80,0x03,0xFF,0xF0,0x80,0x00,0xF8,0x80
.db 0x06,0xFF,0x03,0xE0,0x80,0x06,0xFF,0xE0,0x80,0x3F,0x00,0x07,0x3F,0x80,0xB5,0xFF
.db 0x80,0x00,0xF0,0x80,0x06,0xFF,0xF0,0x80,0x00,0xF0,0x80,0x06,0xFF,0xF0,0xFE,0xF0
.db 0x80,0x06,0xFF,0x07,0x01,0xE0,0x80,0x06,0xFF,0x80,0x00,0x80,0x1F,0x00,0x80,0xCF
.db 0xFF,0x01,0x80,0x06,0x00,0x03,0xE0,0xFC,0x80,0x05,0xFF,0x80,0x00,0xFC,0x80,0x00
.db 0xF0,0xFE,0x80,0x04,0xFF,0x80,0x00,0xF0,0xFF,0xC0,0xF0,0x80,0x05,0xFF,0xE0,0xF8
.db 0x80,0x07,0x00,0x80,0xF0,0xFF,0xC0,0xF0,0xFE,0x80,0x04,0xFF,0xF0,0xFF,0xFF,0xC0
.db 0xF0,0xFC,0x80,0xE0,0xFF,0x00,0x00,0x3C,0x80,0x03,0x2A,0x80,0x02,0x00,0x8B,0x88
.db 0x89,0x52,0x21,0x80,0x02,0x00,0xC7,0x28,0xE8,0x28,0xE7,0x00,0x00,0x87,0xF7,0xF7
.db 0xEF,0xDF,0xDF,0xFF,0x80,0xFF
; 
; RLE WB compressed - Original size= 6144 - Final size= 497
titlescreen_COL:
.db 0x80,0x03,0x41,0x80,0xFE,0xF4,0x80,0xFE,0xF4,0x80,0xFE,0xF4,0x80,0xFE,0xF4,0x80
.db 0xBD,0xF4,0x80,0xFE,0x74,0x80,0xFE,0x74,0x80,0x8F,0x74,0x80,0x1A,0x34,0x31,0x41
.db 0x41,0x80,0x04,0x34,0x31,0x80,0x37,0x41,0x80,0x04,0x74,0x54,0x74,0x54,0x80,0x97
.db 0x47,0x80,0x08,0x43,0x80,0x05,0x31,0x80,0x08,0x43,0x80,0x03,0x31,0x80,0x03,0x43
.db 0x80,0x03,0x31,0x80,0x3B,0x43,0x80,0x07,0x54,0x80,0x97,0x47,0x80,0x0C,0x34,0x31
.db 0x31,0x23,0x80,0x05,0x41,0xC1,0x23,0x80,0x04,0x34,0x31,0x31,0x32,0x80,0x05,0x43
.db 0x80,0x39,0x24,0x80,0x07,0x54,0x80,0x91,0x47,0x80,0x08,0x41,0x80,0x04,0x31,0x80
.db 0x17,0x23,0x41,0x41,0x80,0x05,0x31,0x80,0x3F,0x41,0x80,0x8F,0x74,0x80,0x06,0x41
.db 0xC4,0x80,0x02,0x31,0x80,0x02,0xC3,0x80,0x06,0x23,0x80,0x14,0x31,0xC3,0xC3,0x80
.db 0x03,0x23,0x80,0x05,0x41,0x80,0x41,0xC4,0x71,0x80,0x84,0x47,0x80,0x07,0xC4,0x80
.db 0x11,0x3C,0x80,0x17,0x31,0x80,0x04,0xC4,0x2C,0x31,0x31,0x80,0x03,0x41,0x4C,0x4C
.db 0x3C,0x23,0x80,0x04,0x41,0x80,0xB2,0xC4,0x80,0x03,0x3C,0x80,0x0A,0x23,0x80,0x07
.db 0x3C,0x80,0x15,0x23,0x80,0x1D,0xC3,0x80,0x04,0x23,0x41,0x80,0xAE,0xC4,0x80,0x07
.db 0x31,0x2C,0x80,0x06,0xC4,0x80,0x27,0xC3,0x80,0x0F,0xC4,0x80,0x07,0x31,0x80,0xAF
.db 0xC4,0x23,0x80,0x03,0xC3,0x80,0x0A,0x4C,0x80,0x27,0xC3,0x80,0x0F,0xC4,0x23,0xC3
.db 0x80,0xC5,0x4C,0x80,0x15,0x23,0x80,0x11,0x3C,0x4C,0x80,0x06,0xC3,0x80,0x03,0x41
.db 0x80,0xCB,0xC4,0x80,0x04,0x31,0x23,0x80,0x02,0xC3,0x23,0x80,0x05,0xC3,0x80,0x0F
.db 0xC4,0x31,0x31,0x23,0x80,0x0C,0xC3,0x80,0xAD,0xC4,0x80,0x07,0x64,0x96,0x96,0x80
.db 0x03,0x41,0x64,0x80,0x02,0x96,0x80,0x02,0x41,0x64,0x64,0x80,0x02,0x91,0x80,0x02
.db 0xC4,0x61,0x80,0x03,0x69,0xC3,0xC2,0x46,0x46,0x80,0x03,0x91,0xC3,0x2C,0x61,0x61
.db 0x80,0x03,0x91,0x41,0x41,0x61,0x61,0x80,0x03,0x91,0x80,0x02,0xC4,0x61,0x61,0x80
.db 0x02,0x96,0x80,0x0F,0xC3,0x80,0x04,0xC4,0x46,0x69,0x69,0x80,0x05,0x41,0x46,0x69
.db 0x80,0x06,0x41,0x80,0x7D,0x46,0x80,0x02,0x96,0x41,0x41,0x64,0x80,0x04,0x96,0x64
.db 0x64,0x80,0x4D,0x69,0x6C,0x6C,0x80,0x05,0x96,0x9C,0x9C,0x80,0x1D,0x96,0x46,0x80
.db 0x06,0x69,0x41,0x64,0x80,0x05,0x96,0x41,0x41,0x64,0x64,0x80,0x03,0x69,0x80,0x03
.db 0x41,0x64,0x80,0x02,0x96,0x80,0x05,0x41,0x46,0x96,0x80,0x06,0x41,0x80,0x40,0x64
.db 0x80,0xBF,0x96,0x41,0x64,0x80,0x05,0x96,0x80,0x02,0x41,0x64,0x64,0x80,0x02,0x96
.db 0x80,0x04,0x41,0x46,0x46,0x96,0x80,0x06,0x41,0x80,0x20,0x64,0x80,0xCF,0x91,0x80
.db 0x07,0x69,0x46,0x80,0x06,0x96,0x41,0x64,0x64,0x80,0x04,0x96,0x80,0x02,0x41,0x80
.db 0x02,0x64,0x96,0x96,0x80,0x05,0x41,0x80,0x09,0x64,0x80,0xEF,0x91,0x61,0x80,0x06
.db 0x96,0x41,0x80,0x02,0x64,0x80,0xE3,0x96,0x80,0x17,0x79,0xE9,0x80,0x06,0x95,0x80
.db 0xFF





; Project: The Alan Random Project (TARP)
; SpriteSet Pattern Data - Size:16x16
; Sprite range: 0 to 4
; RLE WB compressed - Original size= 160 - Compress size= 116
titlescreen_SPRPATTERNS:
.db 0x01,0x0F,0x38,0x60,0x40,0x80,0x04,0xC0,0x40,0x60,0x30,0x18,0x0C,0x06,0xC0,0xF0
.db 0x1C,0x06,0x06,0x80,0x03,0x03,0x02,0x06,0x04,0x08,0x08,0x18,0x18,0x80,0x06,0x03
.db 0x02,0x04,0x08,0x10,0x20,0x40,0x40,0x80,0x00,0x80,0x00,0x80,0x03,0x08,0x0F,0x08
.db 0x80,0x09,0x00,0x07,0x1C,0x30,0x60,0x40,0x80,0x03,0xC0,0xE0,0x60,0x30,0x18,0x0C
.db 0x04,0x06,0xE0,0x38,0x0C,0x04,0x06,0x80,0x04,0x03,0x06,0x06,0x0C,0x18,0x10,0x20
.db 0x03,0x03,0x80,0x02,0x06,0x7C,0x0C,0x80,0x08,0x00,0x10,0x30,0x80,0x02,0x20,0x60
.db 0x40,0x40,0x20,0x10,0x08,0x04,0x04,0x02,0x01,0x01,0x88,0x80,0x02,0x00,0x88,0x80
.db 0x1A,0x00,0x80,0xFF



__endasm;
}



void setTileset() __naked
{
__asm
  ld hl,#TILESET_PAT
  ld de,#BASE12
  call unRLEWBVRAM
  
  ld hl,#TILESET_PAT
  ld de,#BASE12 + 2048
  call unRLEWBVRAM
  
  ld hl,#TILESET_PAT
  ld de,#BASE12 + 4096
  call unRLEWBVRAM
           
  ld hl,#TILESET_COL
  ld de,#BASE11
  call unRLEWBVRAM
  
  ld hl,#TILESET_COL
  ld de,#BASE11 + 2048
  call unRLEWBVRAM
  
  ld hl,#TILESET_COL
  ld de,#BASE11 + 4096
  jp unRLEWBVRAM
  
 


; Project: The Alan Random Project (TARP)
; tileset pattern
; Tiles range: 0 to 255
; RLE WB compressed - Original size= 2048 - Compress size= 1786
TILESET_PAT:
.db 0xFF,0xC1,0x80,0x02,0x9C,0xC1,0x80,0x02,0xFF,0xE7,0xC7,0xE7,0xE7,0xC3,0x80,0x02
.db 0xFF,0x81,0xFC,0xC1,0x9F,0x80,0x00,0x80,0x02,0xFF,0x81,0xFC,0xE1,0xFC,0x81,0x80
.db 0x02,0xFF,0x9C,0x9C,0x80,0x00,0xFC,0xFC,0x80,0x02,0xFF,0x80,0x00,0x9F,0x81,0xFC
.db 0x81,0x80,0x02,0xFF,0xC1,0x9F,0x81,0x9C,0xC1,0x80,0x02,0xFF,0x80,0x00,0xFC,0xF9
.db 0xF3,0xF3,0x80,0x02,0xFF,0xC1,0x9C,0xC1,0x9C,0xC1,0x80,0x02,0xFF,0xC1,0x9C,0xC0
.db 0xFC,0xC1,0x80,0x08,0xFF,0x00,0x80,0x02,0xFF,0xC3,0x80,0x03,0xFF,0x3F,0x71,0x77
.db 0x73,0x77,0x77,0x3F,0x00,0xF8,0xBC,0x3C,0xBC,0xBC,0x1C,0xF8,0x00,0xF8,0x3C,0xDC
.db 0xBC,0x7C,0x1C,0xF8,0x00,0xF8,0x3C,0xDC,0xBC,0xDC,0x3C,0xF8,0x00,0x00,0x72,0x25
.db 0x25,0x27,0x25,0x80,0x02,0x00,0x60,0x50,0x60,0x50,0x60,0x80,0x02,0x00,0x6E,0x80
.db 0x02,0x84,0x64,0x00,0xFF,0x00,0xC8,0xA8,0xA8,0xC8,0xAE,0x80,0x02,0x00,0x6A,0x8A
.db 0x4E,0x2A,0xCA,0x80,0x02,0x00,0xB7,0xA2,0xB2,0xA2,0xA2,0x80,0x02,0x00,0x60,0x78
.db 0x7E,0x78,0x60,0x80,0x02,0x00,0x80,0x04,0x7E,0x80,0x02,0x00,0x7E,0x63,0x63,0x7E
.db 0x60,0x80,0x02,0x00,0x80,0x03,0x60,0x7F,0x80,0x02,0x00,0x3E,0x63,0x63,0x7F,0x63
.db 0x80,0x02,0x00,0x66,0x66,0x3C,0x18,0x18,0x00,0x00,0x80,0x02,0xFF,0x84,0xF5,0x85
.db 0xF5,0x84,0x80,0x02,0xFF,0x21,0xBD,0xA1,0xBD,0x21,0x80,0x02,0x00,0x80,0x00,0xF7
.db 0x94,0x94,0xF7,0x80,0x03,0x00,0xB8,0x24,0x24,0xA4,0x80,0x08,0x00,0x80,0x03,0x0C
.db 0x00,0x0C,0x00,0x00,0x14,0x14,0x80,0x05,0x00,0x14,0x3E,0x14,0x3E,0x14,0x00,0x00
.db 0x08,0x3E,0x68,0x3E,0x0B,0x3E,0x08,0x00,0x00,0x33,0x36,0x0C,0x1B,0x33,0x80,0x02
.db 0x00,0x38,0x6C,0x3D,0x66,0x3D,0x80,0x02,0x00,0x18,0x30,0x80,0x04,0x00,0x06,0x80
.db 0x04,0x0C,0x06,0x00,0x30,0x80,0x04,0x18,0x30,0x00,0x00,0x5A,0x3C,0x7E,0x3C,0x5A
.db 0x80,0x02,0x00,0x18,0x18,0x7E,0x18,0x18,0x80,0x05,0x00,0x18,0x18,0x10,0x80,0x03
.db 0x00,0x7E,0x80,0x07,0x00,0x18,0x18,0x80,0x02,0x00,0x06,0x0C,0x18,0x30,0x60,0x80
.db 0x02,0x00,0x3E,0x80,0x02,0x63,0x3E,0x80,0x02,0x00,0x18,0x38,0x18,0x18,0x3C,0x80
.db 0x02,0x00,0x7E,0x03,0x3E,0x60,0x7F,0x80,0x02,0x00,0x7E,0x03,0x1E,0x03,0x7E,0x80
.db 0x02,0x00,0x63,0x63,0x7F,0x03,0x03,0x80,0x02,0x00,0x7F,0x60,0x7E,0x03,0x7E,0x80
.db 0x02,0x00,0x3E,0x60,0x7E,0x63,0x3E,0x80,0x02,0x00,0x7F,0x03,0x06,0x0C,0x0C,0x80
.db 0x02,0x00,0x3E,0x63,0x3E,0x63,0x3E,0x80,0x02,0x00,0x3E,0x63,0x3F,0x03,0x3E,0x80
.db 0x02,0x00,0x18,0x18,0x00,0x18,0x18,0x80,0x02,0x00,0x18,0x18,0x00,0x18,0x18,0x10
.db 0x00,0x00,0x0C,0x18,0x30,0x18,0x0C,0x80,0x03,0x00,0x3C,0x00,0x3C,0x80,0x03,0x00
.db 0x30,0x18,0x0C,0x18,0x30,0x80,0x02,0x00,0x1E,0x33,0x06,0x0C,0x00,0x0C,0x00,0x3E
.db 0x41,0x5D,0x55,0x5F,0x40,0x3E,0x00,0x3E,0x63,0x63,0x7F,0x63,0x63,0x00,0x00,0x7E
.db 0x63,0x7E,0x63,0x63,0x7E,0x00,0x00,0x3F,0x80,0x03,0x60,0x3F,0x00,0x00,0x7E,0x80
.db 0x03,0x63,0x7E,0x00,0x00,0x7F,0x60,0x7C,0x60,0x60,0x7F,0x00,0x00,0x7F,0x60,0x7C
.db 0x80,0x02,0x60,0x00,0x00,0x3F,0x60,0x60,0x67,0x63,0x3F,0x00,0x00,0x63,0x63,0x7F
.db 0x80,0x02,0x63,0x00,0x00,0x80,0x05,0x0C,0x00,0x00,0x80,0x04,0x0C,0x38,0x00,0x00
.db 0x63,0x66,0x7C,0x66,0x63,0x63,0x00,0x00,0x80,0x04,0x60,0x7F,0x00,0x00,0x63,0x77
.db 0x7F,0x6B,0x63,0x63,0x00,0x00,0x63,0x73,0x7B,0x6F,0x67,0x63,0x00,0x00,0x3E,0x80
.db 0x03,0x63,0x3E,0x00,0x00,0x7E,0x63,0x63,0x7E,0x60,0x60,0x00,0x00,0x3E,0x63,0x63
.db 0x6B,0x66,0x3D,0x00,0x00,0x7E,0x63,0x63,0x7E,0x63,0x63,0x00,0x00,0x3F,0x60,0x3E
.db 0x03,0x03,0x7E,0x00,0x00,0x7E,0x80,0x04,0x18,0x00,0x00,0x80,0x04,0x63,0x3E,0x00
.db 0x00,0x80,0x03,0x63,0x36,0x1C,0x00,0x00,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00,0x00
.db 0x63,0x36,0x1C,0x1C,0x36,0x63,0x00,0x00,0x80,0x02,0x66,0x3C,0x18,0x18,0x00,0x00
.db 0x7F,0x06,0x0C,0x18,0x30,0x7F,0x00,0x00,0x0E,0x80,0x04,0x0C,0x0E,0x00,0x00,0x60
.db 0x30,0x18,0x0C,0x06,0x00,0x00,0x38,0x80,0x04,0x18,0x38,0x00,0x10,0x38,0x6C,0x80
.db 0x0A,0x00,0x7E,0x80,0x09,0x00,0x3E,0x03,0x3F,0x63,0x7F,0x00,0x00,0x60,0x7E,0x80
.db 0x02,0x63,0x7E,0x80,0x02,0x00,0x3F,0x80,0x02,0x60,0x3F,0x00,0x00,0x03,0x3F,0x80
.db 0x02,0x63,0x3F,0x80,0x02,0x00,0x3E,0x63,0x7F,0x60,0x3E,0x80,0x02,0x00,0x3E,0x60
.db 0x78,0x60,0x60,0x80,0x02,0x00,0x3E,0x63,0x63,0x3F,0x03,0x3E,0x00,0x60,0x7E,0x80
.db 0x03,0x63,0x00,0x00,0x0C,0x00,0x80,0x03,0x0C,0x00,0x00,0x0C,0x00,0x80,0x03,0x0C
.db 0x38,0x00,0x00,0x66,0x66,0x7C,0x66,0x63,0x00,0x00,0x80,0x05,0x18,0x80,0x02,0x00
.db 0x7E,0x80,0x03,0x6B,0x80,0x02,0x00,0x7E,0x80,0x03,0x63,0x80,0x02,0x00,0x3E,0x80
.db 0x02,0x63,0x3E,0x80,0x02,0x00,0x7E,0x80,0x02,0x63,0x7E,0x60,0x00,0x00,0x3F,0x80
.db 0x02,0x63,0x3F,0x03,0x00,0x00,0x3F,0x80,0x03,0x60,0x80,0x02,0x00,0x3F,0x60,0x3E
.db 0x03,0x7E,0x00,0x00,0x18,0x3E,0x80,0x02,0x18,0x0E,0x80,0x02,0x00,0x80,0x03,0x63
.db 0x3E,0x80,0x02,0x00,0x80,0x02,0x63,0x36,0x1C,0x80,0x02,0x00,0x63,0x80,0x02,0x6B
.db 0x36,0x80,0x02,0x00,0x66,0x3C,0x18,0x3C,0x66,0x80,0x02,0x00,0x80,0x02,0x63,0x3F
.db 0x03,0x3E,0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x80,0x0A,0x00,0x63,0x63,0x7F,0x63
.db 0x63,0x80,0x02,0x00,0x7F,0x60,0x7E,0x60,0x7F,0x00,0x00,0x80,0x0F,0xE0,0x80,0x08
.db 0x00,0x3E,0x63,0x7F,0x63,0x63,0x80,0x02,0x00,0x7E,0x63,0x7E,0x63,0x7E,0x80,0x02
.db 0x00,0x3F,0x80,0x02,0x60,0x3F,0x80,0x02,0x00,0x7E,0x80,0x02,0x63,0x7E,0x80,0x02
.db 0x00,0x7F,0x60,0x7C,0x60,0x7F,0x80,0x02,0x00,0x7F,0x60,0x7C,0x60,0x60,0x80,0x02
.db 0x00,0x3F,0x60,0x67,0x63,0x3F,0x80,0x02,0x00,0x63,0x63,0x7F,0x63,0x63,0x80,0x02
.db 0x00,0x1E,0x80,0x02,0x0C,0x1E,0x80,0x02,0x00,0x1E,0x0C,0x0C,0x6C,0x38,0x80,0x02
.db 0x00,0x63,0x66,0x7C,0x66,0x63,0x80,0x02,0x00,0x80,0x03,0x60,0x7F,0x80,0x02,0x00
.db 0x63,0x77,0x7F,0x6B,0x63,0x80,0x02,0x00,0x63,0x73,0x7B,0x6F,0x67,0x80,0x02,0x00
.db 0x3E,0x80,0x02,0x63,0x3E,0x80,0x02,0x00,0x7E,0x63,0x63,0x7E,0x60,0x80,0x02,0x00
.db 0x3E,0x63,0x6B,0x66,0x3D,0x80,0x02,0x00,0x7E,0x63,0x63,0x7E,0x63,0x80,0x02,0x00
.db 0x3F,0x60,0x3E,0x03,0x7E,0x80,0x02,0x00,0x7E,0x80,0x03,0x18,0x80,0x02,0x00,0x80
.db 0x03,0x63,0x3E,0x80,0x02,0x00,0x80,0x02,0x63,0x36,0x1C,0x80,0x02,0x00,0x63,0x6B
.db 0x7F,0x77,0x63,0x80,0x02,0x00,0x63,0x36,0x1C,0x36,0x63,0x80,0x02,0x00,0x66,0x66
.db 0x3C,0x18,0x18,0x80,0x02,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x80,0x02,0x00,0x18,0x18
.db 0x00,0x18,0x18,0x80,0x02,0x00,0xF0,0x92,0x92,0x12,0x1E,0x80,0x02,0x00,0x7C,0xFE
.db 0xBA,0x82,0x82,0x7C,0x00,0x00,0xF0,0x92,0x92,0x12,0x1E,0x80,0x02,0x00,0x7C,0xFE
.db 0xBA,0x82,0x82,0x7C,0x00,0x80,0x04,0xFF,0xFC,0xF8,0xF8,0x80,0x04,0xFF,0x80,0x02
.db 0x00,0x80,0x04,0xFF,0x3F,0x1F,0x1F,0xF8,0xF8,0xFC,0xFF,0xFF,0xFC,0xF8,0xF8,0x80
.db 0x02,0x00,0xFF,0xFF,0x80,0x05,0x00,0xFF,0xFF,0x3C,0x18,0x18,0x1F,0x1F,0x3F,0xFF
.db 0xFF,0x3F,0x1F,0x1F,0x80,0x07,0xF8,0x80,0x07,0x1F,0x80,0x09,0x18,0x3C,0xFF,0xFF
.db 0x80,0x02,0x00,0x18,0x18,0x38,0xF8,0xF8,0x38,0x18,0x18,0xF8,0xF8,0xFC,0x80,0x04
.db 0xFF,0x80,0x02,0x00,0x80,0x04,0xFF,0x1F,0x1F,0x3F,0x80,0x04,0xFF,0x18,0x18,0x38
.db 0x80,0x04,0xF8,0x18,0x18,0x1C,0x1F,0x1F,0x1C,0x18,0x18,0x80,0x04,0xFF,0x3C,0x18
.db 0x18,0x1F,0x1F,0x3F,0xFF,0xFF,0x80,0x02,0x00,0x18,0x18,0x3C,0xFF,0xFF,0x3C,0x80
.db 0x03,0x18,0x3C,0x80,0x04,0xFF,0x1F,0x1F,0x3F,0xFF,0xFF,0x3C,0x18,0x18,0x80,0x07
.db 0xFF,0x00,0x7E,0x63,0x63,0x7E,0x63,0x80,0x02,0x00,0x63,0x73,0x7B,0x6F,0x67,0x80
.db 0x02,0x00,0x7E,0x80,0x02,0x63,0x7E,0x00,0x00,0xE0,0x80,0x04,0xF0,0xE0,0x00,0x07
.db 0x80,0x04,0x0F,0x07,0x00,0x80,0x02,0x7F,0x41,0x80,0x02,0x7F,0x00,0x7F,0x77,0x77
.db 0x41,0x77,0x77,0x7F,0x00,0x7F,0x7F,0x41,0x63,0x77,0x7F,0x7F,0x00,0x7F,0x41,0x77
.db 0x7F,0x77,0x63,0x7F,0x00,0xFF,0x9F,0xE7,0xF9,0xFE,0xFF,0xFF,0x00,0x80,0x03,0xFF
.db 0x7F,0x9F,0xFF,0x00,0xFF,0xFF,0xFE,0xF9,0xE7,0x9F,0xFF,0x00,0xFF,0x9F,0x7F,0x80
.db 0x03,0xFF,0x00,0xFF,0xBF,0xDF,0xEE,0xF5,0xFB,0xFF,0x00,0xFF,0xBF,0x7F,0x80,0x03
.db 0xFF,0x00,0xFF,0xFB,0xF5,0xEE,0xDF,0xBF,0xFF,0x00,0x80,0x03,0xFF,0x7F,0xBF,0xFF
.db 0x00,0xFF,0x81,0xBD,0xBD,0xFD,0xFC,0xFF,0x00,0x80,0x02,0xFF,0xEF,0xEF,0x0F,0xFF
.db 0x00,0xFF,0xE7,0xDB,0xBD,0xFE,0xFF,0xFF,0x00,0x80,0x02,0xFF,0xEF,0xDF,0x3F,0xFF
.db 0x00,0xFF,0x8F,0xF7,0xFB,0xFD,0xFE,0xFF,0x00,0x80,0x04,0xFF,0x3F,0xFF,0x00,0xFF
.db 0xBF,0xDF,0xE0,0x80,0x02,0xFF,0x00,0x80,0x02,0xFF,0x3F,0xDF,0xEF,0xFF,0x00,0x80
.db 0x06,0xFF,0x00,0x83,0x80,0x04,0x7D,0x83,0xFF,0x83,0x80,0x04,0x01,0x83,0xFF,0x83
.db 0x80,0x04,0x01,0x83,0xFF,0x83,0x80,0x04,0x01,0x83,0xFF,0x83,0x80,0x04,0x01,0x83
.db 0x80,0x04,0xFF,0x83,0xC7,0xEF,0xFF,0x00,0x78,0x7C,0x7E,0x7C,0x78,0x00,0x00,0x0C
.db 0x14,0x80,0x02,0x64,0x14,0x0C,0x00,0x0C,0x14,0x80,0x02,0x64,0x14,0x0C,0x80,0x02
.db 0x00,0x18,0x24,0x24,0x18,0x80,0x03,0x00,0x18,0x3C,0x3C,0x18,0x80,0x03,0x00,0x18
.db 0x3C,0x3C,0x18,0x00,0x00,0x7F,0x80,0x04,0x80,0x7F,0x00,0xFE,0x80,0x04,0x81,0xFE
.db 0x00,0x00,0x80,0x03,0x54,0x80,0x07,0x00,0x03,0x07,0x1F,0x00,0x03,0x0F,0x7F,0x80
.db 0x03,0xFF,0x3F,0x80,0x06,0xFF,0xFC,0x80,0x06,0xFF,0x00,0xC0,0xF0,0xFE,0x80,0x03
.db 0xFF,0x80,0x04,0x00,0xC0,0xE0,0xF8,0x80,0x02,0x00,0x01,0x01,0x03,0x07,0x07,0x3F
.db 0x7F,0x80,0x0D,0xFF,0xFC,0xFE,0x80,0x05,0xFF,0x80,0x02,0x00,0x80,0x00,0x80,0x00
.db 0xC0,0xE0,0xE0,0x0F,0x80,0x02,0x1F,0x3F,0x3F,0x7F,0x7F,0xF0,0x80,0x02,0xF8,0xFC
.db 0xFC,0xFE,0xFE,0x7F,0x7F,0x80,0x05,0xFF,0xFE,0xFE,0x80,0x05,0xFF,0x80,0x07,0x00
.db 0x80,0x05,0xFF,0x7F,0x7F,0x80,0x05,0xFF,0xFE,0xFE,0x7F,0x7F,0x3F,0x3F,0x80,0x02
.db 0x1F,0x0F,0xFE,0xFE,0xFC,0xFC,0x80,0x02,0xF8,0xF0,0x07,0x07,0x03,0x01,0x01,0x80
.db 0x02,0x00,0x80,0x05,0xFF,0x7F,0x3F,0x80,0x05,0xFF,0xFE,0xFC,0xE0,0xE0,0xC0,0x80
.db 0x00,0x80,0x00,0x80,0x02,0x00,0x1F,0x07,0x03,0x80,0x04,0x00,0x80,0x03,0xFF,0x7F
.db 0x0F,0x03,0x00,0x80,0x06,0xFF,0x3F,0x80,0x06,0xFF,0xFC,0x80,0x03,0xFF,0xFE,0xF0
.db 0xC0,0x00,0xF8,0xE0,0xC0,0x80,0x14,0x00,0x80,0xFF



; Project: The Alan Random Project (TARP)
; tileset color - type:G2
; Tiles range: 0 to 255
; RLE WB compressed - Original size= 2048 - Compress size= 301
TILESET_COL:
.db 0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF
.db 0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF
.db 0x80,0x06,0x2F,0xEF,0x80,0x06,0x2F,0xEF,0x80,0x07,0x2E,0x80,0x06,0x2F,0xEF,0x80
.db 0x1F,0x4E,0x80,0x06,0x74,0xFE,0x80,0x06,0x74,0xFE,0x80,0x06,0x74,0xE4,0x80,0x06
.db 0x74,0xFE,0x80,0x06,0x74,0xFE,0x80,0x06,0x74,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x06
.db 0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x06
.db 0xF4,0xFE,0x80,0x0F,0x1E,0x80,0x0F,0x41,0x80,0xFE,0x1E,0x80,0xFE,0x1E,0x80,0xD9
.db 0x1E,0x80,0x06,0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x07,0x45
.db 0x80,0x07,0x75,0x80,0xEF,0xDE,0x80,0x0F,0xD1,0x80,0xB7,0x5E,0x80,0x06,0xF4,0xFE
.db 0x80,0x06,0xF4,0xFE,0x80,0x06,0xF4,0xFE,0x80,0x2F,0x4E,0xFE,0x80,0x05,0xF4,0x80
.db 0x04,0xFE,0x80,0x02,0xF4,0x80,0x02,0xFE,0x80,0x04,0xF4,0xFE,0xFE,0x80,0x05,0xF4
.db 0xFE,0xFE,0x80,0x05,0xF4,0xFE,0xFE,0x80,0x05,0xF4,0xFE,0xFE,0x80,0x05,0xF4,0x80
.db 0x04,0xFE,0x80,0x02,0xF4,0xFE,0xFE,0x80,0x05,0xF4,0x80,0x03,0xFE,0x80,0x03,0xF4
.db 0xFE,0xFE,0x80,0x05,0xF4,0x80,0x03,0xFE,0x80,0x03,0xF4,0xFE,0xFE,0x80,0x05,0xF4
.db 0x80,0x05,0xFE,0xF4,0xF4,0xFE,0xFE,0x80,0x05,0xF4,0x80,0x03,0xFE,0x80,0x03,0xF4
.db 0x80,0x08,0xFE,0x80,0x07,0x14,0x80,0x07,0x1C,0x80,0x07,0x18,0x80,0x07,0x17,0x80
.db 0x07,0x1F,0x80,0x07,0x17,0x80,0x07,0x8E,0x80,0x07,0x5E,0x80,0x07,0x3E,0x80,0x07
.db 0x1E,0x80,0x07,0xCE,0x80,0x07,0x9E,0x15,0x80,0x04,0x1C,0x15,0xFE,0x15,0x80,0x04
.db 0x18,0x15,0xFE,0x80,0x06,0x51,0xFE,0x80,0xFE,0x61,0x61,0x80,0xFF

__endasm;
}





// set sprites data in vram
void setSprites() __naked
{
__asm

  ld   HL,#SPRITES_DATA
  ld   DE,#BASE14
  jp   unRLEWBVRAM
  

; Project: The Alan Random Project (TARP)
; SpriteSet Pattern Data - Size:16x16
; Sprite range: 0 to 7
; RLE WB compressed - Original size= 256 - Compress size= 184
SPRITES_DATA:
.db 0x80,0x06,0x00,0x01,0x01,0x80,0x0D,0x00,0x80,0x00,0x80,0x00,0x80,0x0C,0x00,0x01
.db 0x03,0x03,0x01,0x80,0x0B,0x00,0x80,0x00,0xC0,0xC0,0x80,0x00,0x80,0x0A,0x00,0x01
.db 0x03,0x07,0x07,0x03,0x01,0x80,0x09,0x00,0x80,0x00,0xC0,0xE0,0xE0,0xC0,0x80,0x00
.db 0x80,0x08,0x00,0x03,0x07,0x80,0x03,0x0F,0x07,0x03,0x80,0x07,0x00,0xC0,0xE0,0x80
.db 0x03,0xF0,0xE0,0xC0,0x80,0x06,0x00,0x01,0x07,0x0F,0x0F,0x1F,0x1F,0x0F,0x0F,0x07
.db 0x01,0x80,0x05,0x00,0x80,0x00,0xE0,0xF0,0xF0,0xF8,0xF8,0xF0,0xF0,0xE0,0x80,0x00
.db 0x80,0x04,0x00,0x03,0x0F,0x1F,0x1F,0x80,0x03,0x3F,0x1F,0x1F,0x0F,0x03,0x80,0x03
.db 0x00,0xC0,0xF0,0xF8,0xF8,0x80,0x03,0xFC,0xF8,0xF8,0xF0,0xC0,0x80,0x02,0x00,0x03
.db 0x0F,0x1F,0x3F,0x3F,0x80,0x03,0x7F,0x3F,0x3F,0x1F,0x0F,0x03,0x00,0x00,0xC0,0xF0
.db 0xF8,0xFC,0xFC,0x80,0x03,0xFE,0xFC,0xFC,0xF8,0xF0,0xC0,0x00,0x07,0x1F,0x3F,0x7F
.db 0x7F,0x80,0x05,0xFF,0x7F,0x7F,0x3F,0x1F,0x07,0xE0,0xF8,0xFC,0xFE,0xFE,0x80,0x05
.db 0xFF,0xFE,0xFE,0xFC,0xF8,0xE0,0x80,0xFF

__endasm;
}




// pantalla principal
void showMainScr() __naked
{
__asm

  ld   HL,#SCR01
  ld   DE,#BASE10
  jp   unRLEWBVRAM


; Project: The Alan Random Project (TARP)
; map size width:32 height:24
; RLE WB compressed - Original size= 768 - Compress size= 393
SCR01:
.db 0xA0,0x80,0x09,0xA1,0xA2,0x80,0x0F,0xFF,0x1C,0x1D,0x1E,0x1F,0xA7,0x93,0x8F,0x8E
.db 0x87,0x80,0x05,0x20,0xA8,0x80,0x13,0xFF,0xA7,0x80,0x02,0x20,0xBB,0x10,0x11,0xB7
.db 0xB8,0xB9,0xBA,0xA8,0x80,0x13,0xFF,0xA7,0x80,0x02,0x20,0xBB,0x7B,0x18,0x19,0x1A
.db 0x1B,0xBA,0xA8,0x80,0x13,0xFF,0xA7,0x20,0x54,0x45,0x4D,0x50,0x4F,0x20,0x20,0xBC
.db 0xBD,0xA8,0x80,0x13,0xFF,0xA3,0x80,0x09,0xA4,0xA6,0x80,0x13,0xFF,0xA7,0x92,0x88
.db 0x99,0x94,0x88,0x8D,0x80,0x03,0x20,0xA8,0x80,0x13,0xFF,0xA7,0x80,0x06,0x20,0x0C
.db 0x0D,0xD8,0xA8,0x80,0x06,0xFF,0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0x80,0x06,0xFF,0xA7
.db 0x80,0x02,0x20,0xBB,0x12,0x13,0xB7,0xB8,0xB9,0xBA,0xA8,0x80,0x05,0xFF,0xE6,0xE7
.db 0x80,0x03,0xE8,0xE9,0xEA,0x80,0x05,0xFF,0xA7,0x20,0x4B,0x69,0x74,0x80,0x03,0x20
.db 0xDF,0xDE,0xA8,0x80,0x05,0xFF,0xEB,0x80,0x05,0xE8,0xEC,0x80,0x05,0xFF,0xA3,0x80
.db 0x09,0xA4,0xA6,0x80,0x05,0xFF,0xED,0x80,0x05,0xE8,0xEE,0x80,0x05,0xFF,0xA7,0x8D
.db 0x85,0x8C,0x8F,0x84,0x99,0x80,0x03,0x20,0xA8,0x80,0x05,0xFF,0xF0,0x80,0x05,0xE8
.db 0xF1,0x80,0x05,0xFF,0xA7,0x80,0x06,0x20,0x0C,0x0E,0xD8,0xA8,0x80,0x05,0xFF,0xF2
.db 0x80,0x05,0xE8,0xF3,0x80,0x05,0xFF,0xA7,0x80,0x02,0x20,0xBB,0x14,0x15,0xB7,0xB8
.db 0xB9,0xBA,0xA8,0x80,0x05,0xFF,0xF4,0xF5,0x80,0x03,0xE8,0xF6,0xF7,0x80,0x05,0xFF
.db 0xA7,0x20,0x41,0x2B,0x42,0x80,0x03,0x20,0xDF,0xDE,0xA8,0x80,0x06,0xFF,0xF8,0xF9
.db 0xFA,0xFB,0xFC,0xFD,0x80,0x06,0xFF,0xA7,0x20,0x4F,0x46,0x46,0x53,0x80,0x02,0x20
.db 0xBC,0xBD,0xA8,0x80,0x13,0xFF,0xA7,0x20,0x45,0x4E,0x56,0x80,0x03,0x20,0xBC,0xBD
.db 0xA8,0x80,0x13,0xFF,0xA7,0x20,0x53,0x50,0x45,0x45,0x44,0x20,0x20,0xBC,0xBD,0xA8
.db 0x80,0x13,0xFF,0xA7,0x20,0x4C,0x4F,0x4F,0x50,0x80,0x02,0x20,0xDF,0xDE,0xA8,0x80
.db 0x13,0xFF,0xA7,0x20,0x4F,0x43,0x54,0x41,0x56,0x45,0x20,0xBC,0xBD,0xA8,0x80,0x13
.db 0xFF,0xA7,0x20,0x55,0x50,0x2F,0x44,0x4F,0x57,0x4E,0xBC,0xBD,0xA8,0x80,0x13,0xFF
.db 0xA3,0x80,0x09,0xA4,0xA6,0x80,0x13,0xFF,0xA7,0x80,0x02,0x20,0xBB,0x7B,0x7C,0x7D
.db 0x19,0x18,0xBA,0xA8,0xFF,0x9F,0x80,0x0F,0xD1,0xFF,0xFF,0xAC,0x80,0x09,0xAD,0xAE
.db 0xFF,0x9E,0x80,0x0F,0xD1,0xFF,0xFF,0x80,0xFF

__endasm;
}




void showHelpScr() __naked
{
__asm

  ld   HL,#SCR02
  ld   DE,#BASE10
  jp   unRLEWBVRAM


; Project: The Alan Random Project (TARP)
; map size width:32 height:24
; RLE WB compressed - Original size= 768 - Compress size= 163
SCR02:
.db 0xA0,0x80,0x13,0xA1,0xB1,0x80,0x07,0xA1,0xA2,0xB6,0xA7,0x88,0x85,0x8C,0x90,0x80
.db 0x0F,0x20,0xA9,0x96,0x80,0x06,0x20,0xA8,0xB6,0xA3,0x80,0x13,0xA4,0xAA,0x80,0x07
.db 0xA4,0xA6,0xB6,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7
.db 0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8
.db 0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C
.db 0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7
.db 0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8
.db 0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C
.db 0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xA7
.db 0x80,0x1C,0x20,0xA8,0x7E,0xA7,0x80,0x1C,0x20,0xA8,0x7E,0xAC,0x80,0x1C,0xAD,0xAE
.db 0xB6,0x80,0xFF

__endasm;
}




/* -----------------------------------------------------------------------------
 set V9938 Palette
----------------------------------------------------------------------------- */
void SetPalette(char number) __naked
{
number;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   A,4(ix)  ;<-- numero de paleta

;recoge la posicion de los datos del mapa usando un indice 
  ld   IX,#palIndex
  
;get ADDR of page data
  or   A
  jr   Z,readPALaddr    ;si es 0 no calcula nada, recoge el primer valor
  sla  A
  ld   E,A
  ld   D,#0
  add  IX,DE

readPALaddr:
  ld   H,1(IX)
  ld   L,(IX)
    
  xor	 A
	di
	out	 (#0x99),A
	ld	 A,#144
	out	 (#0x99),A
	ld	 BC,#0x209A
	otir
	ei
  
  pop  IX  
  ret 
  
palIndex:
.dw TITLE_PAL,MAIN_PAL,HELP_PAL
  

; RB,G
TITLE_PAL:
.db 0x00,0x00
.db 0x00,0x00
.db 0x01,0x06
.db 0x03,0x07
.db 0x24,0x03
.db 0x27,0x03
.db 0x51,0x01
.db 0x27,0x06
.db 0x71,0x01
.db 0x73,0x03
.db 0x61,0x06
.db 0x64,0x06
.db 0x01,0x05
.db 0x65,0x02
.db 0x55,0x05
.db 0x77,0x07


; RB,G
MAIN_PAL:
.db 0x00,0x00
.db 0x00,0x00
.db 0x44,0x04
.db 0x33,0x07
.db 0x17,0x03
.db 0x33,0x03
.db 0x61,0x01
.db 0x27,0x06
.db 0x71,0x01
.db 0x73,0x03
.db 0x61,0x06
.db 0x64,0x06
.db 0x11,0x04
.db 0x65,0x02
.db 0x66,0x06
.db 0x77,0x07


HELP_PAL:
.db 0x00,0x00
.db 0x00,0x00
.db 0x44,0x04
.db 0x33,0x07
.db 0x33,0x03
.db 0x37,0x04
.db 0x61,0x01
.db 0x47,0x06
.db 0x71,0x01
.db 0x73,0x03
.db 0x61,0x06
.db 0x64,0x06
.db 0x11,0x04
.db 0x65,0x02
.db 0x66,0x06
.db 0x77,0x07


__endasm;
}




